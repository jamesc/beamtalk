{
  // Beamtalk Development Container Configuration
  //
  // Dockerfile: Installs all core development dependencies (Rust, Erlang, Node.js, etc.)
  // This file: Configures GitHub Copilot CLI, VS Code extensions, and workspace setup
  "name": "Beamtalk Development",
  "build": {
    "dockerfile": "Dockerfile",
    "context": ".."
  },
  "features": {
    "ghcr.io/devcontainers/features/copilot-cli:1": {}
  },
  "customizations": {
    "vscode": {
      "extensions": [
        "rust-lang.rust-analyzer",
        "tamasfe.even-better-toml",
        "fill-labs.dependi",
        "vadimcn.vscode-lldb",
        "usernamehw.errorlens",
        "erlang-ls.erlang-ls",
        "github.copilot",
        "github.vscode-github-actions",
        "github.vscode-pull-request-github",
        "linear.linear",
        "ms-vscode-remote.remote-containers"
      ],
      "settings": {
        "rust-analyzer.check.command": "clippy",
        "rust-analyzer.cargo.features": "all",
        "editor.formatOnSave": true,
        "[rust]": {
          "editor.defaultFormatter": "rust-lang.rust-analyzer"
        },
        "files.watcherExclude": {
          "**/target/**": true
        }
      }
    }
  },
  // initializeCommand: Ensure .env file exists before container starts (--env-file requires it)
  "initializeCommand": "pwsh -NoProfile -File ${localWorkspaceFolder}/.devcontainer/ensure-env-file.ps1",
  "postCreateCommand": "sudo chown -R vscode:vscode ${containerWorkspaceFolder} /usr/local/cargo/registry /home/vscode/.copilot && cargo fetch",
  "postStartCommand": "bash .devcontainer/setup-git-auth.sh || true",
  "remoteUser": "vscode",
  // Cargo caching for faster builds
  // NOTE: For worktrees, the main .git mount is added via CLI --mount argument in worktree-up.ps1
  // because ${localEnv:...} variable substitution doesn't work reliably with devcontainer CLI
  "mounts": [
    "source=beamtalk-cargo-cache,target=/usr/local/cargo/registry,type=volume",
    "source=${localWorkspaceFolderBasename}-target-cache,target=${containerWorkspaceFolder}/target,type=volume",
    "source=beamtalk-copilot-state,target=/home/vscode/.copilot,type=volume"
  ],
  // ═══════════════════════════════════════════════════════════════════════════
  // DEVELOPMENT WORKFLOWS
  // ═══════════════════════════════════════════════════════════════════════════
  // 1. VS Code (simple): Open folder in VS Code, it will build the devcontainer
  //    - Basic git config from GIT_USER_NAME/GIT_USER_EMAIL env vars
  //    - Can build and develop normally
  //
  // 2. Git Worktrees (advanced): Use scripts/worktree-up.ps1 for parallel work
  //    - Creates worktrees with isolated containers
  //    - Sets up SSH commit signing
  //    - Configures Copilot CLI with MCP
  //    - See scripts/worktree-up.ps1 for details
  // ═══════════════════════════════════════════════════════════════════════════
  "containerEnv": {
    "CARGO_TARGET_DIR": "${containerWorkspaceFolder}/target"
  },
  "runArgs": [
    "--env-file=${localWorkspaceFolder}/.env",
    "--label=git.worktree=${localWorkspaceFolderBasename}"
  ],
  "remoteEnv": {
    "LINEAR_API_TOKEN": "${localEnv:LINEAR_API_TOKEN}",
    "GH_TOKEN": "${localEnv:GH_TOKEN}",
    "GITHUB_TOKEN": "${localEnv:GH_TOKEN}",
    "GIT_USER_NAME": "${localEnv:GIT_USER_NAME}",
    "GIT_USER_EMAIL": "${localEnv:GIT_USER_EMAIL}"
  }
}
