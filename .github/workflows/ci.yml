# Copyright 2026 James Casey
# SPDX-License-Identifier: Apache-2.0

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - name: Install Erlang/OTP
        uses: erlef/setup-beam@v1
        with:
          otp-version: '27.0'
          rebar3-version: '3.23'

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Build
        run: cargo build --all-targets

      - name: Clippy
        run: cargo clippy --all-targets -- -D warnings

      - name: Format check
        run: cargo fmt --all -- --check

      - name: Test
        run: cargo test --all-targets

      - name: Test Erlang runtime (unit tests)
        run: |
          cd runtime
          rebar3 eunit --module=beamtalk_actor_tests,beamtalk_future_tests,beamtalk_repl_tests,beamtalk_e2e_tests

      - name: Test Erlang runtime (integration tests)
        run: |
          # Start compiler daemon in background
          ./target/debug/beamtalk daemon start --foreground &
          DAEMON_PID=$!
          
          # Ensure cleanup happens even if tests fail
          cleanup() {
            kill $DAEMON_PID 2>/dev/null || true
          }
          trap cleanup EXIT
          
          # Wait for daemon to initialize and verify it stays alive
          # Poll for up to 10 seconds to ensure daemon is ready
          echo "Waiting for daemon to initialize..."
          for i in $(seq 1 10); do
            if ! kill -0 "$DAEMON_PID" 2>/dev/null; then
              echo "Daemon process exited before integration tests could run"
              exit 1
            fi
            # Check if socket is ready (daemon creates ~/.beamtalk/daemon.sock)
            if [ -S "$HOME/.beamtalk/daemon.sock" ]; then
              echo "Daemon is ready (socket exists)"
              break
            fi
            sleep 1
          done
          
          # Final verification that daemon is still running
          if ! kill -0 "$DAEMON_PID" 2>/dev/null; then
            echo "Compiler daemon failed to start or exited prematurely"
            exit 1
          fi
          
          # Run integration tests
          cd runtime
          rebar3 eunit --module=beamtalk_repl_integration_tests

  coverage:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview

      - name: Install Erlang/OTP
        uses: erlef/setup-beam@v1
        with:
          otp-version: '27.0'
          rebar3-version: '3.23'

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-coverage-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-coverage-
            ${{ runner.os }}-cargo-

      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@cargo-llvm-cov

      - name: Generate Rust coverage
        run: |
          cargo llvm-cov --all-targets --workspace --lcov --output-path lcov.info \
            -- --skip commands::build::tests::test_build_single_file \
               --skip commands::build::tests::test_build_multiple_files \
               --skip commands::run::tests::test_run_calls_build

      - name: Generate Erlang coverage
        run: |
          cd runtime
          rebar3 eunit --module=beamtalk_actor_tests,beamtalk_future_tests,beamtalk_repl_tests,beamtalk_e2e_tests --cover
          rebar3 cover --verbose

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: ./lcov.info,./runtime/_build/test/cover/eunit.coverdata
          flags: rust,erlang
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false
