# Copyright 2026 James Casey
# SPDX-License-Identifier: Apache-2.0

name: Nightly Fuzzing

on:
  schedule:
    # Run at 2 AM UTC every day
    - cron: '0 2 * * *'
  workflow_dispatch:
    # Allow manual triggering for testing

permissions:
  contents: read
  issues: write

env:
  CARGO_TERM_COLOR: always

jobs:
  fuzz:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v6

      - name: Install Rust nightly toolchain
        uses: dtolnay/rust-toolchain@nightly

      - name: Cache cargo registry
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            fuzz/target
          key: ${{ runner.os }}-cargo-fuzz-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-fuzz-

      - name: Install cargo-fuzz
        run: cargo install cargo-fuzz --locked --version 0.13.1

      - name: Run parser fuzzing (10 minutes)
        id: fuzz
        continue-on-error: true
        run: |
          # Run fuzzing for 600 seconds (10 minutes)
          # -rss_limit_mb=4096: Limit memory to 4GB to catch OOM issues faster
          # -max_total_time=600: Run for exactly 10 minutes
          cargo +nightly fuzz run parse_arbitrary -- \
            -rss_limit_mb=4096 \
            -max_total_time=600 \
            -print_final_stats=1

      - name: Upload artifacts on failure
        if: steps.fuzz.outcome == 'failure'
        uses: actions/upload-artifact@v6
        with:
          name: fuzz-artifacts-${{ github.run_id }}
          path: fuzz/artifacts/parse_arbitrary/
          retention-days: 30

      - name: Check for fuzz failures
        if: steps.fuzz.outcome == 'failure'
        run: |
          FAILED=0

          # Check if there are any crash artifacts
          if ls fuzz/artifacts/parse_arbitrary/crash-* 1> /dev/null 2>&1; then
            echo "âŒ CRITICAL: Parser crashed during fuzzing!"
            echo "Crash artifacts uploaded. Please investigate immediately."
            FAILED=1
          fi
          
          # Check for timeouts
          if ls fuzz/artifacts/parse_arbitrary/timeout-* 1> /dev/null 2>&1; then
            echo "âš ï¸ WARNING: Parser timeout detected"
            echo "This indicates infinite loop or extremely slow parsing."
            FAILED=1
          fi
          
          # Check for OOM
          if ls fuzz/artifacts/parse_arbitrary/oom-* 1> /dev/null 2>&1; then
            echo "âŒ Parser out-of-memory detected on malformed input"
            echo "The parser consumed >4GB on crafted input, preventing effective fuzzing."
            echo "Add resource limits (max AST depth, max token count) to the parser."
            FAILED=1
          fi

          # Fail if fuzz step failed but produced no artifacts (infra error, cargo-fuzz crash, etc.)
          if [ $FAILED -eq 0 ]; then
            echo "âŒ Fuzz step failed but no artifacts were produced; failing to avoid false green."
            FAILED=1
          fi

          exit $FAILED

      - name: Create issue on failure
        if: steps.fuzz.outcome == 'failure'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            
            const artifactsDir = 'fuzz/artifacts/parse_arbitrary/';
            let files = [];
            
            try {
              files = fs.readdirSync(artifactsDir);
            } catch (e) {
              console.log('No artifacts directory found');
              return;
            }
            
            const crashes = files.filter(f => f.startsWith('crash-'));
            const ooms = files.filter(f => f.startsWith('oom-'));
            const timeouts = files.filter(f => f.startsWith('timeout-'));
            
            if (crashes.length === 0 && ooms.length === 0 && timeouts.length === 0) {
              console.log('No failure artifacts found, not creating issue');
              return;
            }
            
            // Build title and body based on artifact types
            const types = [];
            if (crashes.length > 0) types.push('crash');
            if (ooms.length > 0) types.push('OOM');
            if (timeouts.length > 0) types.push('timeout');
            
            const title = `ðŸ”€ Parser fuzzing failure: ${types.join(', ')} (run ${context.runId})`;
            
            let details = '';
            if (crashes.length > 0) {
              details += `\n### Crashes (${crashes.length})\n${crashes.map(c => `- \`${c}\``).join('\n')}\n`;
            }
            if (ooms.length > 0) {
              details += `\n### Out-of-Memory (${ooms.length})\n${ooms.map(c => `- \`${c}\``).join('\n')}\nThe parser used >4GB on crafted input. Add resource limits (max AST depth, max token count).\n`;
            }
            if (timeouts.length > 0) {
              details += `\n### Timeouts (${timeouts.length})\n${timeouts.map(c => `- \`${c}\``).join('\n')}\nThe parser took too long, indicating an infinite loop or pathological input.\n`;
            }
            
            const body = [
              `## Parser Fuzzing Failure`,
              ``,
              `The nightly fuzzer found issues in the parser.`,
              ``,
              `**Run:** ${context.runId}`,
              `**Workflow:** ${context.workflow}`,
              `**Date:** ${new Date().toISOString()}`,
              details,
              `### Action Required`,
              ``,
              `1. Download the \`fuzz-artifacts-${context.runId}\` artifact from the workflow run`,
              `2. Reproduce: \`cargo +nightly fuzz run parse_arbitrary <artifact-file>\``,
              `3. Fix the issue in the parser`,
              `4. Re-run fuzzer to verify fix`,
              ``,
              `### References`,
              ``,
              `- ADR 0011: Robustness Testing â€” Layered Fuzzing`,
              `- Epic: BT-362`,
              `- Workflow run: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
            ].join('\n');
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['Bug', 'parser', 'fuzzing', 'High']
            });

      - name: Add to job summary
        if: always()
        run: |
          echo "## ðŸ”€ Fuzzing Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.fuzz.outcome }}" = "success" ]; then
            echo "âœ… **Success:** No crashes detected in 10-minute fuzz run" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Issues Detected:** See artifacts for details" >> $GITHUB_STEP_SUMMARY
            
            # List artifact types found
            if ls fuzz/artifacts/parse_arbitrary/crash-* 1> /dev/null 2>&1; then
              echo "- âŒ **Crashes:** Parser panicked on some input" >> $GITHUB_STEP_SUMMARY
            fi
            if ls fuzz/artifacts/parse_arbitrary/timeout-* 1> /dev/null 2>&1; then
              echo "- â±ï¸ **Timeouts:** Parser took too long on some input" >> $GITHUB_STEP_SUMMARY
            fi
            if ls fuzz/artifacts/parse_arbitrary/oom-* 1> /dev/null 2>&1; then
              echo "- ðŸ’¾ **OOM:** Parser used excessive memory on malformed input" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Corpus size:** $(ls -1 fuzz/corpus/parse_arbitrary/ | wc -l) files" >> $GITHUB_STEP_SUMMARY
          echo "**Duration:** 10 minutes" >> $GITHUB_STEP_SUMMARY

  extended-proptest:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v6

      - name: Install Rust stable toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-proptest-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-proptest-

      - name: Run extended proptest (10,000 cases)
        id: proptest
        run: cargo test -p beamtalk-core property_tests -- --nocapture
        env:
          PROPTEST_CASES: 10000

      - name: Add to job summary
        if: always()
        run: |
          echo "## ðŸŽ² Extended Proptest Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.proptest.outcome }}" = "success" ]; then
            echo "âœ… **Success:** All property tests passed with 10,000 cases" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Failure:** Property tests found a failing case" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Proptest automatically shrinks to a minimal failing input." >> $GITHUB_STEP_SUMMARY
            echo "Check the job logs for the shrunk test case." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Cases per property:** 10,000" >> $GITHUB_STEP_SUMMARY
          echo "**Standard CI cases:** 512" >> $GITHUB_STEP_SUMMARY
