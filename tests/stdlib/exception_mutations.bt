// BT-410: State mutation threading in on:do: and ensure: handler blocks
// Tests that actor field mutations inside exception handling blocks are
// properly threaded back to the actor state.

// @load tests/e2e/fixtures/error_counter.bt

// === on:do: handler field mutation ===

// Spawn actor with initial state (value=0, errorCount=0)
c := ErrorCounter spawn
// => #Actor<ErrorCounter,_>

// riskyIncrement triggers 1/0 exception, handler increments errorCount
c riskyIncrement
// => #Actor<_>

// Verify errorCount was mutated by the handler
c getErrorCount await
// => 1

// Value should be unchanged (try body failed before mutation completed)
c getValue await
// => 0

// Call again to verify mutation accumulates
c riskyIncrement
// => #Actor<_>

c getErrorCount await
// => 2

// === ensure: cleanup field mutation ===

// Spawn a fresh actor
d := ErrorCounter spawn
// => #Actor<ErrorCounter,_>

// safeIncrementWithCleanup: body increments value, cleanup increments errorCount
d safeIncrementWithCleanup
// => #Actor<_>

// Value should be incremented by the try body
d getValue await
// => 1

// errorCount should be incremented by the cleanup block
d getErrorCount await
// => 1

// Call again to verify both accumulate
d safeIncrementWithCleanup
// => #Actor<_>

d getValue await
// => 2

d getErrorCount await
// => 2
