// Copyright 2026 James Casey
// SPDX-License-Identifier: Apache-2.0

// Stdlib tests for JSON class (BT-711)
// Tests JSON parsing, generating, and pretty printing via jsx backend.
//
// Note: Beamtalk string literals include backslash escapes literally,
// so we avoid embedded quotes/braces in JSON test strings where possible.
// For JSON objects, we use generate→parse round-trips or access individual values.

// ===========================================================================
// PARSING — PRIMITIVE VALUES
// ===========================================================================

// Parse a JSON integer
JSON parse: "42"
// => 42

// Parse a JSON float
JSON parse: "3.14"
// => 3.14

// Parse JSON true
JSON parse: "true"
// => true

// Parse JSON false
JSON parse: "false"
// => false

// Parse JSON null to nil
JSON parse: "null"
// => nil

// ===========================================================================
// PARSING — ARRAYS
// ===========================================================================

// Parse a JSON array of integers
JSON parse: "[1, 2, 3]"
// => [1,2,3]

// Parse a nested array
JSON parse: "[[1, 2], [3, 4]]"
// => [[1,2],[3,4]]

// Parse a mixed array — verify size and individual access
(JSON parse: "[1, true, null]") size
// => 3

// Parse an empty array
JSON parse: "[]"
// => []

// ===========================================================================
// GENERATING — BEAMTALK VALUE TO JSON STRING
// ===========================================================================

// Generate JSON from a List
JSON generate: #(1, 2, 3)
// => [1,2,3]

// Generate JSON from an Integer
JSON generate: 42
// => 42

// Generate JSON from true
JSON generate: true
// => true

// Generate JSON from false
JSON generate: false
// => false

// Generate JSON from nil (becomes null)
JSON generate: nil
// => null

// Generate JSON from an empty List
JSON generate: #()
// => []

// ===========================================================================
// ROUND-TRIP — GENERATE THEN PARSE
// ===========================================================================

// Round-trip an integer
JSON parse: (JSON generate: 42)
// => 42

// Round-trip a boolean
JSON parse: (JSON generate: true)
// => true

// Round-trip null
JSON parse: (JSON generate: nil)
// => nil

// Round-trip an array
JSON parse: (JSON generate: #(1, 2, 3))
// => [1,2,3]

// Round-trip a Dictionary
(JSON parse: (JSON generate: #{"name" => "Ada"})) at: "name"
// => Ada

// Round-trip nested structures
((JSON parse: (JSON generate: #{"user" => #{"age" => 36}})) at: "user") at: "age"
// => 36

// ===========================================================================
// DICTIONARY GENERATE AND PARSE
// ===========================================================================

// Generate JSON from a Dictionary, then verify structure
(JSON generate: #{"a" => 1}) size > 2
// => true

// Generate and re-parse a Dictionary
(JSON parse: (JSON generate: #{"x" => 10, "y" => 20})) at: "x"
// => 10

(JSON parse: (JSON generate: #{"x" => 10, "y" => 20})) at: "y"
// => 20

(JSON parse: (JSON generate: #{"x" => 10, "y" => 20})) size
// => 2

// Dictionary with nested List
(JSON parse: (JSON generate: #{"items" => #(1, 2, 3)})) at: "items"
// => [1,2,3]

// Dictionary with boolean values
(JSON parse: (JSON generate: #{"active" => true})) at: "active"
// => true

// Dictionary with null value
(JSON parse: (JSON generate: #{"value" => nil})) at: "value"
// => nil

// ===========================================================================
// PRETTY PRINTING
// ===========================================================================

// Pretty print produces a non-empty string
(JSON prettyPrint: #{"a" => 1}) size > 0
// => true

// Pretty print produces same data as generate when re-parsed
(JSON parse: (JSON prettyPrint: #{"a" => 1})) at: "a"
// => 1

// ===========================================================================
// ERROR HANDLING
// ===========================================================================

// Parse invalid JSON produces a parse_error
JSON parse: "not json"
// => ERROR: parse_error

// Parse with non-string argument produces type_error
JSON parse: 42
// => ERROR: type_error

// ===========================================================================
// CLASS IDENTITY
// ===========================================================================

// JSON is a class — class on class returns Metaclass
JSON class
// => Metaclass
