// Copyright 2026 James Casey
// SPDX-License-Identifier: Apache-2.0

// Tests for self-reference behavior (BT-172)
// Migrated from E2E: cross-expression variable resolution (BT-459)
//
// Tests that:
// - Methods can return self
// - Self in block refers to enclosing actor, not block
// - Returned self reference is the same actor (shared state)

// @load tests/e2e/fixtures/self_ref_actor.bt

// Spawn actor
a := SelfRefActor spawn
// => #Actor<SelfRefActor,_>

// ===========================================================================
// METHOD RETURNING SELF
// ===========================================================================

// returnSelf returns the actor's self reference
ref := a returnSelf await
// => #Actor<SelfRefActor,_>

// The returned reference responds to class
ref class
// => SelfRefActor

// The returned reference is the same actor (can send messages through it)
(ref setValue: 99) await
// => _

// Verify the state changed on the original actor (same process)
a getValue await
// => 99

// ===========================================================================
// SELF IN BLOCK
// ===========================================================================

// classInBlock evaluates self.class inside a block
// self in block refers to enclosing actor, not the block itself
a classInBlock await
// => SelfRefActor

// ===========================================================================
// DYNAMIC DISPATCH VIA PERFORM:
// ===========================================================================

// perform: dispatches zero-arg methods dynamically on actors
(a perform: #getValue) await
// => 99

// perform:withArguments: dispatches methods with arguments on actors
(a perform: #setValue: withArguments: #(42)) await
// => _

a getValue await
// => 42

// perform: also works on primitives (synchronous dispatch)
42 perform: #asString
// => 42

// perform:withArguments: works on primitives
10 perform: #+ withArguments: #(32)
// => 42
