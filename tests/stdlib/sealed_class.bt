// Copyright 2026 James Casey
// SPDX-License-Identifier: Apache-2.0

// E2E tests for sealed class codegen optimization (BT-403)
//
// Sealed classes use optimized self-dispatch:
// - Direct function calls for self-sends (skip safe_dispatch try/catch)
// - Standalone __sealed_* method functions (skip dispatch/4 case matching)
//
// These tests verify the optimized codegen produces correct results.
// NOTE: Self-sends don't thread state (BT-245), so we test via external calls.

// @load tests/e2e/fixtures/sealed_counter.bt

// Spawn a sealed counter
c := SealedCounter spawn
// => _

// Basic read: getValue (uses __sealed_getValue direct call internally)
c getValue await
// => 0

// Mutation via external call: increment
c increment await
// => 1

// Verify state persisted after increment
c getValue await
// => 1

// Second increment
c increment await
// => 2

// Decrement
c decrement await
// => 1

// Keyword message with parameter: addAmount:
// Parentheses needed: unary messages bind tighter than keyword messages
(c addAmount: 10) await
// => 11

// Internal self-send: getValuePlusTen calls self getValue (tests __sealed_* direct call)
c getValuePlusTen await
// => 21

// Final state verification
c getValue await
// => 11
