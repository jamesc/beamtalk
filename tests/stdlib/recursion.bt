// Copyright 2026 James Casey
// SPDX-License-Identifier: Apache-2.0

// Tests for recursive method dispatch BT-330
// Migrated from E2E: cross-expression variable resolution (BT-459)
// Verifies that methods can call themselves recursively via self.

// @load tests/e2e/fixtures/math_helper.bt

// ===========================================================================
// SETUP
// ===========================================================================

m := MathHelper new
// => a MathHelper

// ===========================================================================
// RECURSIVE KEYWORD METHOD: FACTORIAL
// ===========================================================================

// Base cases
m factorial: 0
// => 1

m factorial: 1
// => 1

// Recursive cases (5+ depth)
m factorial: 5
// => 120

m factorial: 10
// => 3628800

// ===========================================================================
// DOUBLE-RECURSIVE KEYWORD METHOD: FIBONACCI
// ===========================================================================

// Base cases
m fibonacci: 0
// => 0

m fibonacci: 1
// => 1

// Recursive cases (5+ depth)
m fibonacci: 5
// => 5

m fibonacci: 10
// => 55

// ===========================================================================
// RECURSIVE COUNTDOWN (DEPTH VERIFICATION)
// ===========================================================================

// Verifies 10+ recursion depth
m countdown: 10
// => 10

m countdown: 20
// => 20

// ===========================================================================
// ACTOR RECURSIVE SELF-SENDS (BT-330 FIX)
// ===========================================================================

// Actor self-sends use synchronous direct dispatch, so recursive methods
// and cross-method self-sends work correctly (no Future/badarith).

// @load tests/e2e/fixtures/recursive_actor.bt

a := RecursiveActor spawn
// => #Actor<RecursiveActor,_>

// Base case (no self-send needed)
(a factorial: 1) await
// => 1

// Recursive self-send on Actor
(a factorial: 5) await
// => 120

(a factorial: 10) await
// => 3628800

// Double recursion on Actor
(a fibonacci: 10) await
// => 55

// Cross-method self-send (self double: n, then * 2)
(a quadruple: 5) await
// => 20
