// Copyright 2026 James Casey
// SPDX-License-Identifier: Apache-2.0

// Tests for is_list guard in mutation-threading codegen paths (BT-524)
// Verifies that do: and inject:into: with field mutations work on non-list collections

// @load tests/e2e/fixtures/collection_mutation_counter.bt

// === List do: with mutation (existing behavior, is_list fast path) ===

counter := CollectionMutationCounter spawn
// => #Actor<CollectionMutationCounter,_>

counter getTotal await
// => 0

(counter sumSet: #(1, 2, 3)) await
// => 6

counter getTotal await
// => 6

// === Set do: with field mutation (BT-524: non-list, to_list fallback) ===

counter2 := CollectionMutationCounter spawn
// => #Actor<CollectionMutationCounter,_>

s := (Set new) fromList: #(1, 2, 3)
// => _

(counter2 sumSet: s) await
// => 6

counter2 getTotal await
// => 6

// === Dictionary inject:into: with field mutation (BT-524: non-list) ===

counter3 := CollectionMutationCounter spawn
// => #Actor<CollectionMutationCounter,_>

(counter3 sumDictValues: (Dictionary new: #{#a => 10, #b => 20, #c => 30})) await
// => 60

counter3 getTotal await
// => 60
