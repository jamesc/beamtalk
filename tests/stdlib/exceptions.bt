// Copyright 2026 James Casey
// SPDX-License-Identifier: Apache-2.0

// E2E tests for exception handling (BT-338)
// Tests Block on:do:, ensure:, and Exception object inspection.

// ===========================================================================
// BLOCK on:do: — BASIC EXCEPTION CATCHING
// ===========================================================================

// Catch division by zero with Exception class
[1 / 0] on: Exception do: [:e | 42]
// => 42

// No exception — returns block value normally
[3 + 4] on: Exception do: [:e | 0]
// => 7

// Catch does_not_understand error
[42 nonExistentMethod] on: Exception do: [:e | 99]
// => 99

// nil as ExClass — catch all (backwards compat)
[1 / 0] on: nil do: [:e | 'nil catches all']
// => nil catches all

// ===========================================================================
// EXCEPTION OBJECT FIELD ACCESS
// ===========================================================================

// Access exception message from caught error
[1 / 0] on: Exception do: [:e | e message]
// => _

// Access exception kind from caught error
[42 noSuchMethod] on: Exception do: [:e | e kind]
// => does_not_understand

// Access exception class from does_not_understand
[42 noSuchMethod] on: Exception do: [:e | e errorClass]
// => Integer

// Access exception selector from does_not_understand
[42 noSuchMethod] on: Exception do: [:e | e selector]
// => noSuchMethod

// Exception printString returns formatted error
[42 noSuchMethod] on: Exception do: [:e | e printString]
// => _

// Exception hint — nil when no hint available
[1 / 0] on: Exception do: [:e | e hint]
// => _

// ===========================================================================
// BLOCK ensure: — CLEANUP HANDLING
// ===========================================================================

// ensure: returns block value when no error
[42] ensure: [nil]
// => 42

// ensure: runs cleanup even when block succeeds
[3 + 4] ensure: [1 + 1]
// => 7

// ensure: re-raises error after running cleanup
// (wrap in on:do: to catch the re-raised error)
[[1 / 0] ensure: [nil]] on: Exception do: [:e | 99]
// => 99

// ===========================================================================
// NESTED EXCEPTION HANDLING
// ===========================================================================

// Nested on:do: — inner handler catches
[[1 / 0] on: Exception do: [:e | 42]] on: Exception do: [:e | 0]
// => 42

// Handler can return any type
[1 / 0] on: Exception do: [:e | 'caught an error']
// => caught an error

// ===========================================================================
// ERROR CLASS HIERARCHY (BT-452)
// ===========================================================================

// Exception class reflects error kind
[42 noSuchMethod] on: Exception do: [:e | e class]
// => RuntimeError

// TypeError for type errors (Tuple at: with non-integer argument)
[#(1, 2, 3) at: 'hello'] on: Exception do: [:e | e class]
// => TypeError

// on: Error do: catches all Error subclasses (RuntimeError, TypeError, etc.)
[42 noSuchMethod] on: Error do: [:e | 'caught by Error']
// => caught by Error

[#(1, 2, 3) at: 'hello'] on: Error do: [:e | 'type caught by Error']
// => type caught by Error

// on: RuntimeError do: catches only RuntimeError kinds
[42 noSuchMethod] on: RuntimeError do: [:e | 'caught by RuntimeError']
// => caught by RuntimeError

// on: TypeError do: catches only TypeError kinds
[#(1, 2, 3) at: 'hello'] on: TypeError do: [:e | 'caught by TypeError']
// => caught by TypeError

// on: RuntimeError do: does NOT catch TypeError — falls through to outer handler
[[#(1, 2, 3) at: 'hello'] on: RuntimeError do: [:e | 'wrong']] on: Exception do: [:e | 'correct']
// => correct

// on: TypeError do: does NOT catch RuntimeError — falls through to outer handler
[[42 noSuchMethod] on: TypeError do: [:e | 'wrong']] on: Exception do: [:e | 'correct']
// => correct

// on: Exception do: still catches everything
[42 noSuchMethod] on: Exception do: [:e | 'exception catches all']
// => exception catches all

[#(1, 2, 3) at: 'hello'] on: Exception do: [:e | 'exception catches type too']
// => exception catches type too

// Exception hierarchy field access — kind preserved through hierarchy
[42 noSuchMethod] on: RuntimeError do: [:e | e kind]
// => does_not_understand

[#(1, 2, 3) at: 'hello'] on: TypeError do: [:e | e kind]
// => type_error

// on: InstantiationError do: catches instantiation_error kinds
[Integer new] on: InstantiationError do: [:e | 'caught instantiation']
// => caught instantiation

// InstantiationError does NOT catch does_not_understand
[[42 noSuchMethod] on: InstantiationError do: [:e | 'wrong']] on: Exception do: [:e | 'correct']
// => correct
