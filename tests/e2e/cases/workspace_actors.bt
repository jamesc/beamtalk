// Copyright 2026 James Casey
// SPDX-License-Identifier: Apache-2.0

// E2E tests for Workspace actor introspection API (BT-423).
//
// Workspace is a singleton actor that provides introspection
// of live actors in the workspace via persistent_term binding.

// @load tests/e2e/fixtures/counter.bt

// ===========================================================================
// WORKSPACE BINDING — CLASS INTROSPECTION
// ===========================================================================

// Workspace class returns WorkspaceEnvironment
Workspace class
// => WorkspaceEnvironment

// Workspace respondsTo: #actors returns true
Workspace respondsTo: #actors
// => true

// Workspace respondsTo: #actorAt: returns true
Workspace respondsTo: #actorAt:
// => true

// Workspace respondsTo: #actorsOf: returns true
Workspace respondsTo: #actorsOf:
// => true

// Workspace respondsTo: unknown method returns false
Workspace respondsTo: #nonExistentMethod
// => false

// ===========================================================================
// WORKSPACE ACTORS — RETURNS A LIST
// ===========================================================================

// Workspace actors returns a list (may contain actors from prior tests)
// Actor list depends on prior test state, keep wildcard
allActors := (Workspace actors) await
// => _

// ===========================================================================
// WORKSPACE ACTORS — WITH LIVE ACTORS
// ===========================================================================

// Record count before spawning (depends on prior tests, keep wildcard)
beforeCount := allActors size
// => _

// Spawn a counter actor
c := Counter spawn
// => #Actor<Counter,_>

// Workspace actors now has more actors (depends on prior tests, keep wildcard)
actors := (Workspace actors) await
// => _

actors size > beforeCount
// => true

// ===========================================================================
// WORKSPACE ACTORS OF — BY CLASS
// ===========================================================================

// Record counter count before spawning second (depends on prior tests, keep wildcard)
countersBefore := (Workspace actorsOf: Counter) await
// => _

countersBeforeSize := countersBefore size
// => _

// Spawn a second counter
c2 := Counter spawn
// => #Actor<Counter,_>

// actorsOf: Counter now returns one more (depends on prior tests, keep wildcard)
countersAfter := (Workspace actorsOf: Counter) await
// => _

countersAfter size > countersBeforeSize
// => true

// ===========================================================================
// WORKSPACE ACTORS — FUNCTIONAL REFERENCES FROM WORKSPACE API
// ===========================================================================

// Actors returned by Workspace are fully functional — pick one and message it
c increment
// => 1

c getValue
// => 1

// Verify actorsOf: returns functional references too (depends on prior tests, keep wildcard)
counterRefs := (Workspace actorsOf: Counter) await
// => _

// Get last element and send it a message
lastCounter := counterRefs last
// => #Actor<Counter,_>

lastCounter getValue
// => 0

// ===========================================================================
// WORKSPACE ACTOR AT — NOT FOUND
// ===========================================================================

// actorAt: with invalid pid returns nil
(Workspace actorAt: "invalid") await
// => nil

// ===========================================================================
// WORKSPACE ACTOR AT — RETURNS ACTOR OBJECT
// ===========================================================================

// actorAt: returns an actor object that responds to messages when found
// (The actor objects returned by actors are already fully functional — tested above)
// Verify actors list contains functional actor objects via actorsOf:
freshActors := (Workspace actorsOf: Counter) await
// => _

freshActors size > 0
// => true

// ===========================================================================
// WORKSPACE SESSIONS
// ===========================================================================

// sessions returns a list
(Workspace sessions) await
// => _

// Workspace respondsTo: #sessions returns true
Workspace respondsTo: #sessions
// => true

// ===========================================================================
// ACTOR LIFECYCLE — isAlive
// ===========================================================================

// isAlive returns true for a live actor
c isAlive
// => true

// ===========================================================================
// ACTOR LIFECYCLE — stop
// ===========================================================================

// Spawn a fresh actor for lifecycle testing
lc := Counter spawn
// => #Actor<Counter,_>

// Actor is alive before stop
lc isAlive
// => true

// Gracefully stop the actor
lc stop
// => ok

// Actor is no longer alive after stop
lc isAlive
// => false

// Stopping an already-stopped actor is idempotent
lc stop
// => ok

// ===========================================================================
// ACTOR LIFECYCLE — kill
// ===========================================================================

// Spawn a fresh actor for kill testing
kc := Counter spawn
// => #Actor<Counter,_>

// Actor is alive before kill
kc isAlive
// => true

// Forcefully kill the actor
kc kill
// => ok

// Actor is no longer alive after kill
kc isAlive
// => false

// ===========================================================================
// ACTOR LIFECYCLE — Workspace actors first stop
// ===========================================================================

// Spawn fresh actors and verify stop works on actor returned from Workspace
wa1 := Counter spawn
// => #Actor<Counter,_>

wa2 := Counter spawn
// => #Actor<Counter,_>

// Get actors of Counter and stop each one that we just spawned
wa1 isAlive
// => true

wa2 isAlive
// => true

wa1 stop
// => ok

wa2 stop
// => ok

wa1 isAlive
// => false

wa2 isAlive
// => false
