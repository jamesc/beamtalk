// Copyright 2026 James Casey
// SPDX-License-Identifier: Apache-2.0

// E2E tests for Workspace bind:as: and unbind: (BT-881).
//
// These tests require E2E because bind:as: and unbind: are
// WorkspaceInterface methods that modify workspace-level state
// and require REPL session binding injection to verify name resolution.

// ===========================================================================
// BIND:AS: — HAPPY PATH
// ===========================================================================

// Register a simple value in the workspace namespace
Workspace bind: 42 as: #MyValue
// => nil

// Registered name resolves in subsequent eval
MyValue
// => 42

// Workspace globals includes the registered name
globals := Workspace globals
// => _

globals includesKey: #MyValue
// => true

globals at: #MyValue
// => 42

// ===========================================================================
// BIND:AS: — OVERWRITE EXISTING USER BINDING
// ===========================================================================

// Re-binding an existing user binding updates the value
Workspace bind: 99 as: #MyValue
// => nil

MyValue
// => 99

// ===========================================================================
// UNBIND: — HAPPY PATH
// ===========================================================================

// Unbind removes the registration
Workspace unbind: #MyValue
// => nil

// Workspace globals no longer includes the unbound name
globals2 := Workspace globals
// => _

globals2 includesKey: #MyValue
// => false

// ===========================================================================
// BIND:AS: — SYSTEM NAME CONFLICT
// ===========================================================================

// Binding a name that is a workspace singleton raises error
[(Workspace bind: 42 as: #Transcript)] on: Error do: [:e | e message]
// => Transcript is a system name and cannot be shadowed

// ===========================================================================
// UNBIND: — NAME NOT FOUND ERROR
// ===========================================================================

// Unbinding a name that was never registered raises error
[(Workspace unbind: #NoSuchBinding)] on: Error do: [:e | e message]
// => NoSuchBinding is not a registered workspace name

// ===========================================================================
// BIND:AS: — ACTOR VALUE
// ===========================================================================

// @load tests/e2e/fixtures/counter.bt

// Register an actor reference
counter := Counter spawn
// => _

Workspace bind: counter as: #SharedCounter
// => nil

// Registered actor resolves and can receive messages
SharedCounter increment
// => 1

SharedCounter getValue
// => 1

// Clean up
Workspace unbind: #SharedCounter
// => nil
