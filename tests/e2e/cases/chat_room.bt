// Copyright 2026 James Casey
// SPDX-License-Identifier: Apache-2.0

// E2E tests for chat room demo (BT-431)
//
// Tests:
// - Actor references stored in Set (ordsets with PIDs)
// - Actor method calls inside do: block (broadcasting)
// - Multi-actor message passing
// - Set and List operations with actors

// @load tests/e2e/fixtures/chat_room.bt

// ===========================================================================
// CHAT ROOM CREATION & BASIC OPERATIONS
// ===========================================================================

// Create a chat room
room := ChatRoom spawn
// => _

// Initially no members
(room online) isEmpty
// => true

// No message history
(room getHistory) size
// => 0

// ===========================================================================
// MEMBERS & SET OPERATIONS
// ===========================================================================

// Create members
alice := ChatMember spawn
// => _

bob := ChatMember spawn
// => _

// Set member names
alice setName: "Alice"
// => _

bob setName: "Bob"
// => _

// Verify names were set
alice getName
// => Alice

bob getName
// => Bob

// Set room references for members
alice setRoom: room
// => _

bob setRoom: room
// => _

// Join the room
room join: alice
// => _

room join: bob
// => _

// Check online members (Set of actor references)
members := room online
// => _

members size
// => 2

// Verify members includes alice (PID comparison in Set)
members includes: alice
// => true

members includes: bob
// => true

// ===========================================================================
// MESSAGE BROADCASTING (actor method calls in do: block)
// ===========================================================================

// Send a message from Alice
room say: "Hello everyone!" from: alice
// => _

// Check message history
history := room getHistory
// => _

history size
// => 1

history first
// => Hello everyone!

// Check that alice received the message (via do: broadcast)
aliceInbox := alice getInbox
// => _

aliceInbox size
// => 1

aliceInbox first
// => Hello everyone!

// Check that bob also received it
bobInbox := bob getInbox
// => _

bobInbox size
// => 1

bobInbox first
// => Hello everyone!

// ===========================================================================
// MULTIPLE MESSAGES
// ===========================================================================

// Bob replies
room say: "Hey Alice!" from: bob
// => _

// History now has 2 messages
(room getHistory) size
// => 2

// Both members received both messages
(alice getInbox) size
// => 2

(bob getInbox) size
// => 2

// ===========================================================================
// MEMBER LEAVING
// ===========================================================================

// Alice leaves
room leave: alice
// => _

// Online members now has only bob
(room online) size
// => 1

(room online) includes: alice
// => false

(room online) includes: bob
// => true

// Message sent after alice leaves
room say: "Anyone there?" from: bob
// => _

// Alice doesn't receive the new message
(alice getInbox) size
// => 2

// Bob receives it
(bob getInbox) size
// => 3

(bob getInbox) last
// => Anyone there?
