// Copyright 2026 James Casey
// SPDX-License-Identifier: Apache-2.0

// E2E tests for chat room demo (BT-431, BT-568)
//
// These tests require E2E because the demo exercises multi-actor message
// passing with workspace variable persistence across many REPL turns. Multiple
// actor references (room, alice, bob, mod) are stored in workspace variables
// and reused across subsequent expressions. BUnit tests run within a single
// compiled expression and cannot hold live actor references across turns.
//
// Tests:
// - Message value types (Object subclass) with new: initialization
// - Actor references stored in Set (ordsets with PIDs)
// - Actor method calls inside do: block (broadcasting)
// - Multi-actor message passing with formatted strings
// - Set and List operations with actors
// - Moderator actor inheritance with super calls

// @load tests/e2e/fixtures/message.bt
// @load tests/e2e/fixtures/chat_room.bt
// @load tests/e2e/fixtures/chat_member.bt
// @load tests/e2e/fixtures/moderator.bt

// ===========================================================================
// MESSAGE VALUE TYPE
// ===========================================================================

// Create a Message with default values
Message new
// => _

// Create a Message with custom values via new:
msgArgs := #{#text => "Hello!", #sender => "Alice"}
// => _

msg := Message new: msgArgs
// => _

msg getText
// => Hello!

msg getSender
// => Alice

msg printString
// => Alice: Hello!

msg class
// => Message

// ===========================================================================
// CHAT ROOM CREATION & BASIC OPERATIONS
// ===========================================================================

// Create a chat room
room := ChatRoom spawn
// => #Actor<ChatRoom,_>

// Initially no members
online := room online
// => Set()

online isEmpty
// => true

// No message history
hist := room getHistory
// => []

hist size
// => 0

// ===========================================================================
// MEMBERS & SET OPERATIONS
// ===========================================================================

// Create members
alice := ChatMember spawn
// => #Actor<ChatMember,_>

bob := ChatMember spawn
// => #Actor<ChatMember,_>

// Set member names
alice setName: "Alice"
// => Alice

bob setName: "Bob"
// => Bob

// Verify names were set
alice getName
// => Alice

bob getName
// => Bob

// Set room references for members
alice setRoom: room
// => #Actor<ChatRoom,_>

bob setRoom: room
// => #Actor<ChatRoom,_>

// Join the room
room join: alice
// => Set(_)

room join: bob
// => Set(_)

// Check online members (Set of actor references)
members := room online
// => Set(_)

members size
// => 2

// Verify members includes alice (PID comparison in Set)
members includes: alice
// => true

members includes: bob
// => true

// ===========================================================================
// MESSAGE BROADCASTING (actor method calls in do: block)
// ===========================================================================

// Send a message from Alice (sender name as string)
room say: "Hello everyone!" from: "Alice"
// => nil

// Check message history â€” formatted as "sender: text" strings
history := room getHistory
// => _

history size
// => 1

history first
// => Alice: Hello everyone!

// Check that alice received the message (via do: broadcast)
aliceInbox := alice getInbox
// => _

aliceInbox size
// => 1

aliceInbox first
// => Alice: Hello everyone!

// Check that bob also received it
bobInbox := bob getInbox
// => _

bobInbox size
// => 1

bobInbox first
// => Alice: Hello everyone!

// ===========================================================================
// MULTIPLE MESSAGES
// ===========================================================================

// Bob replies
room say: "Hey Alice!" from: "Bob"
// => nil

// History now has 2 messages
history2 := room getHistory
// => _

history2 size
// => 2

history2 last
// => Bob: Hey Alice!

// Both members received both messages
aliceInbox2 := alice getInbox
// => _

aliceInbox2 size
// => 2

bobInbox2 := bob getInbox
// => _

bobInbox2 size
// => 2

// ===========================================================================
// MEMBER LEAVING
// ===========================================================================

// Alice leaves
room leave: alice
// => Set(_)

// Online members now has only bob
onlineAfter := room online
// => Set(_)

onlineAfter size
// => 1

onlineAfter includes: alice
// => false

onlineAfter includes: bob
// => true

// Message sent after alice leaves
room say: "Anyone there?" from: "Bob"
// => nil

// Alice doesn't receive the new message
aliceInbox3 := alice getInbox
// => _

aliceInbox3 size
// => 2

// Bob receives it
bobInbox3 := bob getInbox
// => _

bobInbox3 size
// => 3

bobInbox3 last
// => Bob: Anyone there?

// ===========================================================================
// MODERATOR (Actor inheritance with super)
// ===========================================================================

// Create a moderator (subclass of ChatMember)
mod := Moderator spawn
// => #Actor<Moderator,_>

mod class
// => Moderator

// Moderator has all ChatMember methods
mod setName: "Admin"
// => Admin

mod getName
// => Admin

mod setRoom: room
// => #Actor<ChatRoom,_>

room join: mod
// => Set(_)

// Moderator can mute members
mod mute: "Bob"
// => Set(_)

mod isMuted: "Bob"
// => true

mod isMuted: "Alice"
// => false

// Unmute
mod unmute: "Bob"
// => Set(_)

mod isMuted: "Bob"
// => false

// ===========================================================================
// MODERATOR KICK (Actor-to-actor method calls)
// ===========================================================================

// Re-add bob to the room for kick test
room join: bob
// => Set(_)

membersBefore := room online
// => Set(_)

membersBefore includes: bob
// => true

// Moderator kicks bob from the room
mod kick: bob
// => _

membersAfter := room online
// => Set(_)

membersAfter includes: bob
// => false

// ===========================================================================
// MODERATOR SAY: SUPER CALL (inheritance + prefix)
// ===========================================================================
//
// DISABLED (BT-918 / ADR 0043): These tests deadlock with sync-by-default dispatch.
// The cycle is: mod say: -> self.room say:from: -> m receiveMessage: (back to mod).
// Fix: use `!` (fire-and-forget cast) for the broadcast in ChatRoom say:from:.
// Re-enable once BT-919 (parser) and BT-920 (codegen) implement `!` syntax.
//
// room join: bob
// // => Set(_)
//
// // Moderator say: prefixes with "[MOD] " then calls super (ChatMember say:)
// (mod say: "Welcome!") await
// // => nil
//
// // Room history should contain the prefixed message
// modHistory := room getHistory
// // => _
//
// modHistory last
// // => Admin: [MOD] Welcome!
//
// // Bob should have received the prefixed message
// bobInboxMod := bob getInbox
// // => _
//
// bobInboxMod last
// // => Admin: [MOD] Welcome!
