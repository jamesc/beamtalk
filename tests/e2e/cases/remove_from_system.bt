// Copyright 2026 James Casey
// SPDX-License-Identifier: Apache-2.0

// E2E tests for Behaviour >> removeFromSystem (BT-785).
//
// These tests require E2E because removeFromSystem modifies the live global
// class registry (persistent_term + BEAM module table) in the running REPL
// process. Workspace variable persistence across turns is needed to hold a
// reference to the class after removal. The :unload deprecation test also
// exercises a REPL command (impossible to invoke from BUnit).
//
// Tests full class removal lifecycle:
//   - Define a class
//   - Verify it exists in Object allSubclasses
//   - Call removeFromSystem
//   - Verify it is gone from Object allSubclasses

// ===========================================================================
// Define a temporary class for removal
// ===========================================================================

Object subclass: TempClassForRemoval
  greet => "hello"
// => _

// Verify class is defined
TempClassForRemoval new greet
// => hello

// Verify it appears in allSubclasses
(Object allSubclasses includes: TempClassForRemoval)
// => true

// ===========================================================================
// removeFromSystem — full cleanup
// ===========================================================================

// Save a reference to the class before removing it
tempClass := TempClassForRemoval
// => _

// Remove the class
TempClassForRemoval removeFromSystem
// => nil

// Verify it is gone from allSubclasses
(Object allSubclasses includes: tempClass)
// => false

// ===========================================================================
// Safety checks — stdlib class rejection
// ===========================================================================

// Attempting to remove Integer raises an error
[Integer removeFromSystem] on: Error do: [:e | "error caught"]
// => error caught

// Attempting to remove String raises an error
[String removeFromSystem] on: Error do: [:e | "error caught"]
// => error caught

// ===========================================================================
// :unload suggestion
// ===========================================================================

:unload Counter
// => ERROR: ':unload' has been removed. Use `removeFromSystem` instead.
