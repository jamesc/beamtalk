// Copyright 2026 James Casey
// SPDX-License-Identifier: Apache-2.0

// E2E test for method patching on file-loaded classes (BT-588)
//
// These tests require E2E because method patching involves the REPL's
// file-loading pipeline (:load via @load directive) and live class mutation
// (>> method definition) in the running REPL process. BUnit tests execute
// compiled code and cannot drive the :load + patch + verify sequence with
// workspace variable persistence across turns.
//
// Tests that standalone method definitions (>>) work on classes
// loaded from files via :load, not just inline-defined classes.
// This was broken because handle_load stored class sources with
// string keys but handle_method_definition looked them up with
// binary keys.
//
// Related: hot_reload_actors.bt â€” tests that existing running actor
// instances pick up patches immediately (distinct focus).

// @load tests/e2e/fixtures/counter.bt

// ===========================================================================
// LOAD + USE CLASS
// ===========================================================================

// Spawn and use the file-loaded Counter
c := Counter spawn
// => #Actor<Counter,_>

c increment
// => 1

c increment
// => 2

c getValue
// => 2

// ===========================================================================
// PATCH METHOD ON FILE-LOADED CLASS
// ===========================================================================

// Replace increment to add 10 instead of 1
Counter >> increment => self.value := self.value + 10
// => _

// New instances should use patched method
c2 := Counter spawn
// => #Actor<Counter,_>

c2 increment
// => 10

c2 getValue
// => 10

// ===========================================================================
// ADD NEW METHOD TO FILE-LOADED CLASS
// ===========================================================================

// Add a new method that didn't exist in the original file
Counter >> doubleValue => self.value * 2
// => _

c3 := Counter spawn
// => #Actor<Counter,_>

c3 increment
// => 10

c3 doubleValue
// => 20

// ===========================================================================
// VERIFY SOURCE UPDATED AFTER PATCHING (BT-589)
// ===========================================================================

// Source for patched method should return the NEW implementation
(Counter >> #increment) source
// => increment => self.value := self.value + 10

// Source for newly added method should return its source
(Counter >> #doubleValue) source
// => doubleValue => self.value * 2
