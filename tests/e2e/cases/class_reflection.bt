// Copyright 2026 James Casey
// SPDX-License-Identifier: Apache-2.0

// E2E tests for Class reflection API
//
// Tests Beamtalk class introspection capabilities:
// - Beamtalk classNamed: - Look up class by name
// - Class methods - Get list of instance methods
// - Class class_name - Get the class name
// - Class superclass - Get the superclass name
// - Class module_name - Get the module name
//
// Class objects are returned by `Beamtalk classNamed:` and support
// reflection messages to introspect the class definition.
//
// BT-374: Beamtalk is a workspace binding (actor) dispatched via
// persistent_term. Sends are async and return Futures, so we must
// `await` to get the actual class object.

// @load lib/SystemDictionary.bt
// @load tests/e2e/fixtures/counter.bt

// ===========================================================================
// CLASS LOOKUP WITH classNamed:
// ===========================================================================

// ---------------------------------------------------------------------------
// Look up existing primitive class
// ---------------------------------------------------------------------------

stringClass := (Beamtalk classNamed: #String) await
// => String

stringClass class_name
// => String

// ---------------------------------------------------------------------------
// Look up existing actor class
// ---------------------------------------------------------------------------

counterClass := (Beamtalk classNamed: #Counter) await
// => Counter

counterClass class_name
// => Counter

// ---------------------------------------------------------------------------
// Look up non-existent class returns nil (await the Future)
// ---------------------------------------------------------------------------

(Beamtalk classNamed: #NonExistentClass) await
// => nil

// ===========================================================================
// CLASS METHODS INTROSPECTION
// ===========================================================================

// ---------------------------------------------------------------------------
// Get methods list from String class
// ---------------------------------------------------------------------------

stringClass := (Beamtalk classNamed: #String) await
// => String

// Method lists are fragile (change when methods are added), keep wildcard
methods := stringClass methods
// => _

// String has many methods (++, size, at:, etc.)
// Just verify we get a non-empty list by checking length
methods isEmpty
// => false

// ---------------------------------------------------------------------------
// Get methods list from Counter class
// ---------------------------------------------------------------------------

counterClass := (Beamtalk classNamed: #Counter) await
// => Counter

counterMethods := counterClass methods
// => _

counterMethods isEmpty
// => false

// Counter should have its local methods
counterMethods includes: #increment
// => true

counterMethods includes: #decrement
// => true

counterMethods includes: #getValue
// => true

// Counter should inherit Object methods via Actor
counterMethods includes: #isNil
// => true

counterMethods includes: #printString
// => true

counterMethods includes: #respondsTo:
// => true

// ---------------------------------------------------------------------------
// Get methods list from Integer class
// ---------------------------------------------------------------------------

intClass := (Beamtalk classNamed: #Integer) await
// => Integer

// Method list fragile (changes when methods are added), keep wildcard
intMethods := intClass methods
// => _

// Integer has arithmetic operators
intMethods isEmpty
// => false

// ===========================================================================
// SUPERCLASS INTROSPECTION
// ===========================================================================

// ---------------------------------------------------------------------------
// String superclass is Object
// ---------------------------------------------------------------------------

stringClass := (Beamtalk classNamed: #String) await
// => String

stringClass superclass
// => Object

// ---------------------------------------------------------------------------
// Counter superclass is Actor
// ---------------------------------------------------------------------------

counterClass := (Beamtalk classNamed: #Counter) await
// => Counter

counterClass superclass
// => Actor

// ---------------------------------------------------------------------------
// Actor superclass is Object
// ---------------------------------------------------------------------------

actorClass := (Beamtalk classNamed: #Actor) await
// => Actor

actorClass superclass
// => Object

// ===========================================================================
// MODULE NAME INTROSPECTION
// ===========================================================================

// ---------------------------------------------------------------------------
// Get module name for primitive class
// ---------------------------------------------------------------------------

stringClass := (Beamtalk classNamed: #String) await
// => String

stringClass module_name
// => bt@stdlib@string

// ---------------------------------------------------------------------------
// Get module name for actor class
// ---------------------------------------------------------------------------

counterClass := (Beamtalk classNamed: #Counter) await
// => Counter

counterClass module_name
// => bt@counter

// ===========================================================================
// CLASS NAME CONSISTENCY
// ===========================================================================

// ---------------------------------------------------------------------------
// Class name matches the lookup name
// ---------------------------------------------------------------------------

stringClass := (Beamtalk classNamed: #String) await
// => String

stringClass class_name
// => String

integerClass := (Beamtalk classNamed: #Integer) await
// => Integer

integerClass class_name
// => Integer

trueClass := (Beamtalk classNamed: #True) await
// => True

trueClass class_name
// => True

// ===========================================================================
// IMPLEMENTATION STATUS
// ===========================================================================
//
// ✅ Beamtalk classNamed: - Returns wrapped class object (async, needs await)
// ✅ Class methods - Returns list of instance methods
// ✅ Class class_name - Returns class name atom
// ✅ Class superclass - Returns superclass name atom
// ✅ Class module_name - Returns module name atom
// ✅ Async dispatch support in handle_cast - Classes handle Future protocol
// ✅ E2E test coverage - This file
