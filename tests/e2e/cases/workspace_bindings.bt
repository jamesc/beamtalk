// Copyright 2026 James Casey
// SPDX-License-Identifier: Apache-2.0

// E2E tests for workspace bindings (BT-376 / ADR 0010 Phase 4).
//
// Workspace bindings (Transcript, Beamtalk) are singleton actors
// looked up via persistent_term. These tests validate that the
// full dispatch pipeline works end-to-end: codegen → persistent_term
// lookup → actor send → future resolution.

// ===========================================================================
// TRANSCRIPT BINDING — BASIC DISPATCH
// ===========================================================================

// Transcript show: dispatches through workspace binding (async send, REPL auto-awaits to nil)
Transcript show: 'Hello'
// => nil

// Transcript cr dispatches through workspace binding (async send, REPL auto-awaits to nil)
Transcript cr
// => nil

// ===========================================================================
// TRANSCRIPT BINDING — CLASS INTROSPECTION
// ===========================================================================

// Transcript class returns TranscriptStream (the actual class of the singleton)
Transcript class
// => TranscriptStream

// Transcript respondsTo: #show: returns true
Transcript respondsTo: #show:
// => true

// Transcript respondsTo: a method it doesn't have
Transcript respondsTo: #nonExistentMethod
// => false

// ===========================================================================
// BEAMTALK BINDING — CLASS INTROSPECTION
// ===========================================================================

// Beamtalk class returns SystemDictionary
Beamtalk class
// => SystemDictionary

// Beamtalk respondsTo: #allClasses returns true
Beamtalk respondsTo: #allClasses
// => true

// ===========================================================================
// BEAMTALK BINDING — METHODS
// ===========================================================================

// Beamtalk allClasses returns a list including core classes
// Class list changes as classes are added, keep wildcard
classes := (Beamtalk allClasses) await
// => _

// Validate allClasses returns a non-empty list
classes isEmpty
// => false

// Beamtalk version returns a string
version := (Beamtalk version) await
// => 0.1.0

// Validate version is a non-empty string
version isEmpty
// => false

// ===========================================================================
// TRANSCRIPT BINDING — CASCADE (SEMICOLON CHAINING)
// ===========================================================================

// Cascade on workspace binding: all messages dispatched to same actor
Transcript show: 'Hello'; cr; show: 'World'
// => nil

// ===========================================================================
// BEAMTALK BINDING — GLOBALS
// ===========================================================================

// Beamtalk globals returns a map (empty in Phase 1)
globals := (Beamtalk globals) await
// => _

// ===========================================================================
// BEAMTALK BINDING — CLASS NAMED
// ===========================================================================

// Beamtalk classNamed: looks up a class by symbol
intClass := (Beamtalk classNamed: #Integer) await
// => Integer

// ===========================================================================
// TRANSCRIPT BINDING — BUFFER OPERATIONS
// ===========================================================================

// Clear transcript buffer first
(Transcript clear) await
// => nil

// Write something to transcript
(Transcript show: 'TestOutput') await
// => nil

// Recent returns buffer contents (list of recent output)
recent := (Transcript recent) await
// => _

// Buffer should not be empty after writing
recent isEmpty
// => false

// Clear empties the buffer
(Transcript clear) await
// => nil

// Buffer should be empty after clear
recentAfterClear := (Transcript recent) await
// => _

recentAfterClear isEmpty
// => true

// ===========================================================================
// TRANSCRIPT BINDING — SUBSCRIBE / UNSUBSCRIBE
// ===========================================================================

// Transcript subscribe dispatches as unary method (BT-530)
(Transcript subscribe) await
// => nil

// Transcript unsubscribe dispatches as unary method (BT-530)
(Transcript unsubscribe) await
// => nil
