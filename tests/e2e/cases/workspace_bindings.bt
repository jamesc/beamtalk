// Copyright 2026 James Casey
// SPDX-License-Identifier: Apache-2.0

// E2E tests for workspace bindings (BT-376 / ADR 0010 Phase 4).
//
// These tests require E2E because workspace bindings (Transcript, Beamtalk)
// are singleton actors registered in the REPL process via persistent_term.
// They are REPL-specific: BUnit tests run in compiled code without access to
// workspace binding infrastructure. Cross-turn variable persistence and
// subscribe/unsubscribe lifecycle are also tested here.
//
// Workspace bindings (Transcript, Beamtalk) are singleton actors
// accessed via workspace convenience bindings. The explicit form
// (e.g., TranscriptStream current) also works via class variables
// (ADR 0019).

// ===========================================================================
// TRANSCRIPT BINDING — BASIC DISPATCH
// ===========================================================================

// Transcript show: dispatches through workspace binding (async send, returns self)
Transcript show: "Hello"
// => #Actor<TranscriptStream,_>

// Transcript cr dispatches through workspace binding (async send, returns self)
Transcript cr
// => #Actor<TranscriptStream,_>

// ===========================================================================
// TRANSCRIPT BINDING — CLASS INTROSPECTION
// ===========================================================================

// Transcript class returns TranscriptStream (the actual class of the singleton)
Transcript class
// => TranscriptStream

// Transcript respondsTo: #show: returns true
Transcript respondsTo: #show:
// => true

// Transcript respondsTo: a method it doesn't have
Transcript respondsTo: #nonExistentMethod
// => false

// ===========================================================================
// BEAMTALK BINDING — CLASS INTROSPECTION
// ===========================================================================

// Beamtalk class returns BeamtalkInterface
Beamtalk class
// => BeamtalkInterface

// Beamtalk respondsTo: #allClasses returns true
Beamtalk respondsTo: #allClasses
// => true

// ===========================================================================
// BEAMTALK BINDING — METHODS
// ===========================================================================

// Beamtalk allClasses returns a list including core classes
// Class list changes as classes are added, keep wildcard
classes := (Beamtalk allClasses)
// => _

// Validate allClasses returns a non-empty list
classes isEmpty
// => false

// Beamtalk version returns a string
version := (Beamtalk version)
// => 0.1.0

// Validate version is a non-empty string
version isEmpty
// => false

// ===========================================================================
// TRANSCRIPT BINDING — CASCADE (SEMICOLON CHAINING)
// ===========================================================================

// Cascade on workspace binding: all messages dispatched to same actor
Transcript show: "Hello"; cr; show: "World"
// => #Actor<TranscriptStream,_>

// ===========================================================================
// BEAMTALK BINDING — GLOBALS
// ===========================================================================

// Beamtalk globals returns a map (class registry snapshot)
globals := (Beamtalk globals)
// => _

// ===========================================================================
// BEAMTALK BINDING — CLASS NAMED
// ===========================================================================

// Beamtalk classNamed: looks up a class by symbol
intClass := (Beamtalk classNamed: #Integer)
// => Integer

// ===========================================================================
// TRANSCRIPT BINDING — BUFFER OPERATIONS
// ===========================================================================

// Clear transcript buffer first
(Transcript clear)
// => #Actor<TranscriptStream,_>

// Write something to transcript
(Transcript show: "TestOutput")
// => #Actor<TranscriptStream,_>

// Recent returns buffer contents (list of recent output)
recent := (Transcript recent)
// => _

// Buffer should not be empty after writing
recent isEmpty
// => false

// Clear empties the buffer
(Transcript clear)
// => #Actor<TranscriptStream,_>

// Buffer should be empty after clear
recentAfterClear := (Transcript recent)
// => _

recentAfterClear isEmpty
// => true

// ===========================================================================
// TRANSCRIPT BINDING — SUBSCRIBE / UNSUBSCRIBE
// ===========================================================================

// Transcript subscribe dispatches as unary method (BT-530)
(Transcript subscribe)
// => #Actor<TranscriptStream,_>

// Transcript unsubscribe dispatches as unary method (BT-530)
(Transcript unsubscribe)
// => #Actor<TranscriptStream,_>

// ===========================================================================
// EXPLICIT FORM — SINGLETON CLASS VARIABLE ACCESS (ADR 0019 Phase 4)
// ===========================================================================

// TranscriptStream current returns the same singleton as Transcript binding
(TranscriptStream current show: "hello from explicit form")
// => #Actor<TranscriptStream,_>

// BeamtalkInterface current works as explicit form of Beamtalk
(BeamtalkInterface current version)
// => 0.1.0
