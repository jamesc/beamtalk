// Copyright 2026 James Casey
// SPDX-License-Identifier: Apache-2.0

// E2E tests for actor field mutations in control flow (BT-98)
//
// These tests verify that field assignments (self.field := value) work correctly
// inside control flow blocks (whileTrue:, whileFalse:, timesRepeat:, to:do:, do:, inject:into:)
//
// The compiler threads actor state (StateAcc) through tail-recursive loops,
// allowing field mutations to persist across iterations.

// @load tests/e2e/fixtures/field_mutation_counter.bt
// @load tests/e2e/fixtures/field_mutation_accumulator.bt
// @load tests/e2e/fixtures/field_mutation_nested.bt

// ===========================================================================
// WHILE TRUE WITH FIELD MUTATIONS
// ===========================================================================

counter := FieldMutationCounter spawn
// => <pid>

counter getValue await
// => 0

counter incrementWhileTrue: 5 await
// => 5

counter getValue await
// => 5

// Test continuing from previous value
counter incrementWhileTrue: 10 await
// => 10

counter getValue await
// => 10

// ===========================================================================
// WHILE FALSE WITH FIELD MUTATIONS
// ===========================================================================

counter2 := FieldMutationCounter spawnWith: #{value => 5}
// => <pid>

counter2 getValue await
// => 5

counter2 decrementWhileFalse await
// => 0

counter2 getValue await
// => 0

// ===========================================================================
// TIMES REPEAT WITH FIELD MUTATIONS
// ===========================================================================

counter3 := FieldMutationCounter spawn
// => <pid>

counter3 getValue await
// => 0

counter3 incrementTimesRepeat: 3 await
// => 3

counter3 getValue await
// => 3

counter3 incrementTimesRepeat: 7 await
// => 10

counter3 getValue await
// => 10

// ===========================================================================
// TO:DO: WITH FIELD MUTATIONS
// ===========================================================================

counter4 := FieldMutationCounter spawn
// => <pid>

counter4 getValue await
// => 0

// Iterate 1 to 5 (5 iterations)
counter4 incrementToDo: 1 to: 5 await
// => 5

counter4 getValue await
// => 5

// Continue from 5
counter4 incrementToDo: 1 to: 10 await
// => 15

counter4 getValue await
// => 15

// ===========================================================================
// COLLECTION DO: WITH FIELD MUTATIONS
// ===========================================================================

counter5 := FieldMutationCounter spawn
// => <pid>

counter5 getValue await
// => 0

// Sum array [1, 2, 3, 4, 5] = 15
counter5 sumArray: #[1, 2, 3, 4, 5] await
// => 15

counter5 getValue await
// => 15

// Continue summing [10, 20, 30] = 60
counter5 sumArray: #[10, 20, 30] await
// => 75

counter5 getValue await
// => 75

// ===========================================================================
// MULTIPLE FIELDS MUTATED TOGETHER
// ===========================================================================

acc := FieldMutationAccumulator spawn
// => <pid>

acc getSum await
// => 0

acc getProduct await
// => 1

acc getCount await
// => 0

// Process [2, 3, 4]
// sum: 0 + 2 + 3 + 4 = 9
// product: 1 * 2 * 3 * 4 = 24
// count: 3
acc processArray: #[2, 3, 4] await
// => #{sum => 9, product => 24, count => 3}

acc getSum await
// => 9

acc getProduct await
// => 24

acc getCount await
// => 3

// ===========================================================================
// INJECT:INTO: WITH FIELD MUTATIONS
// ===========================================================================

acc2 := FieldMutationAccumulator spawn
// => <pid>

acc2 getCount await
// => 0

// Inject adds numbers, field tracks iteration count
// [1, 2, 3, 4, 5] sum = 15, count = 5
acc2 accumulateWithInject: #[1, 2, 3, 4, 5] await
// => #{result => 15, count => 5}

acc2 getCount await
// => 5

// Continue with more items
acc2 accumulateWithInject: #[10, 20, 30] await
// => #{result => 60, count => 8}

acc2 getCount await
// => 8

// ===========================================================================
// MIXED LOCAL VARIABLES AND FIELDS
// ===========================================================================

mixed := FieldMutationAccumulator spawnWith: #{sum => 0}
// => <pid>

// Local tracks count, field tracks sum
mixed processWithLocal: #[5, 10, 15] await
// => #{localSum => 3, sum => 30}

// Continue processing
mixed processWithLocal: #[1, 2, 3, 4] await
// => #{localSum => 4, sum => 40}

// ===========================================================================
// NESTED CONTROL FLOW WITH FIELD MUTATIONS
// ===========================================================================

nested := FieldMutationNested spawn
// => <pid>

nested getValue await
// => 0

// 3 * 4 = 12 increments
nested nestedIncrement: 3 inner: 4 await
// => 12

nested getValue await
// => 12

// Continue: 2 * 5 = 10 more increments
nested nestedIncrement: 2 inner: 5 await
// => 22

nested getValue await
// => 22

// ===========================================================================
// TO:BY:DO: WITH FIELD MUTATIONS (BT-35)
// ===========================================================================

stepper := FieldMutationCounter spawn
// => <pid>

stepper getValue await
// => 0

// Sum odd numbers 1 to 10: 1 + 3 + 5 + 7 + 9 = 25
stepper sumRangeBy: 1 to: 10 by: 2 await
// => 25

stepper getValue await
// => 25

// Continue with multiples of 5: 0 + 5 + 10 = 15
stepper sumRangeBy: 0 to: 10 by: 5 await
// => 40

stepper getValue await
// => 40

// ===========================================================================
// EDGE CASE: EMPTY COLLECTIONS
// ===========================================================================

counter6 := FieldMutationCounter spawnWith: #{value => 100}
// => <pid>

counter6 getValue await
// => 100

// Empty array should not change value
counter6 sumArray: #[] await
// => 100

counter6 getValue await
// => 100

// ===========================================================================
// EDGE CASE: SINGLE ITERATION
// ===========================================================================

counter7 := FieldMutationCounter spawn
// => <pid>

counter7 getValue await
// => 0

counter7 incrementTimesRepeat: 1 await
// => 1

counter7 getValue await
// => 1

counter7 incrementToDo: 5 to: 5 await
// => 2

counter7 getValue await
// => 2
