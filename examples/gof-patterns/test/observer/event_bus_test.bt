// Copyright 2026 James Casey
// SPDX-License-Identifier: Apache-2.0

// Tests for Observer Pattern â€” EventBus and EventCollector
//
// With sync-by-default dispatch, bus notify: calls receive: on each subscriber
// synchronously. When notify: returns, all subscribers have processed the event.

TestCase subclass: EventBusTest

  testSubscribeAndNotify =>
    bus := EventBus spawn
    col := EventCollector spawn
    bus subscribe: col
    bus notify: "hello"
    self assert: (col eventCount) equals: 1
    self assert: ((col events) first) equals: "hello"
    bus stop
    col stop

  testMultipleNotifications =>
    bus := EventBus spawn
    col := EventCollector spawn
    bus subscribe: col
    bus notify: "a"
    bus notify: "b"
    bus notify: "c"
    self assert: (col eventCount) equals: 3
    bus stop
    col stop

  testUnsubscribeStopsNotifications =>
    bus := EventBus spawn
    col := EventCollector spawn
    bus subscribe: col
    bus notify: "before"
    bus unsubscribe: col
    bus notify: "after"
    self assert: (col eventCount) equals: 1
    self assert: ((col events) first) equals: "before"
    bus stop
    col stop

  testMultipleSubscribers =>
    bus := EventBus spawn
    c1  := EventCollector spawn
    c2  := EventCollector spawn
    bus subscribe: c1
    bus subscribe: c2
    bus notify: "event"
    self assert: (c1 eventCount) equals: 1
    self assert: (c2 eventCount) equals: 1
    bus stop
    c1 stop
    c2 stop

  testNoSubscribersNoError =>
    bus := EventBus spawn
    col := EventCollector spawn
    bus notify: "ghost"
    self assert: (col eventCount) equals: 0
    bus stop
    col stop
