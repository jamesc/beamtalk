// Copyright 2026 James Casey
// SPDX-License-Identifier: Apache-2.0

// BUnit tests for the ChatRoom and ChatMember actors.
//
// With sync-by-default dispatch, room say:from: calls receiveMessage: on each
// member synchronously. When say:from: returns, all members have processed
// the message â€” no sync barriers are needed.
//
// Run in the REPL:
//   > :load src/message.bt
//   > :load src/chat_room.bt
//   > :load src/chat_member.bt
//   > :load src/moderator.bt
//   > :load test/chat_room_test.bt
//   > ChatRoomTest runAll

TestCase subclass: ChatRoomTest

  testNewRoomHasNoHistory =>
    room := ChatRoom spawn.
    self assert: (room getHistory) equals: #()

  testMemberJoinsRoom =>
    room := ChatRoom spawn.
    alice := ChatMember spawn.
    room join: alice.
    self assert: ((room online) includes: alice)

  testMemberLeavesRoom =>
    room := ChatRoom spawn.
    alice := ChatMember spawn.
    room join: alice.
    room leave: alice.
    self deny: ((room online) includes: alice)

  testSayAddsToHistory =>
    room := ChatRoom spawn.
    room say: "Hello!" from: "Alice".
    self assert: (room getHistory) equals: #("Alice: Hello!")

  testSayMultipleMessages =>
    room := ChatRoom spawn.
    room say: "Hello!" from: "Alice".
    room say: "Hey!" from: "Bob".
    self assert: (room getHistory) equals: #("Alice: Hello!", "Bob: Hey!")

  testMemberReceivesMessage =>
    room := ChatRoom spawn.
    alice := ChatMember spawn.
    room join: alice.
    room say: "Hello!" from: "System".
    self assert: (alice getInbox) equals: #("System: Hello!")

  testMemberDoesNotReceiveAfterLeaving =>
    room := ChatRoom spawn.
    alice := ChatMember spawn.
    room join: alice.
    room leave: alice.
    room say: "Hello?" from: "System".
    self assert: (alice getInbox) equals: #()

  testBroadcastToMultipleMembers =>
    room := ChatRoom spawn.
    alice := ChatMember spawn.
    bob := ChatMember spawn.
    room join: alice.
    room join: bob.
    room say: "Hi all!" from: "System".
    self assert: (alice getInbox) equals: #("System: Hi all!").
    self assert: (bob getInbox) equals: #("System: Hi all!")

  testOnlyRemainingMemberReceives =>
    room := ChatRoom spawn.
    alice := ChatMember spawn.
    bob := ChatMember spawn.
    room join: alice.
    room join: bob.
    room leave: alice.
    room say: "Anyone there?" from: "System".
    self assert: (alice getInbox) equals: #().
    self assert: (bob getInbox) equals: #("System: Anyone there?")

  testMemberSetsName =>
    alice := ChatMember spawn.
    alice setName: "Alice".
    self assert: (alice getName) equals: "Alice"

  testMemberDefaultName =>
    self assert: (ChatMember spawn getName) equals: "Guest"
