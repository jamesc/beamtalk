// Copyright 2026 James Casey
// SPDX-License-Identifier: Apache-2.0

// BUnit tests for the Account actor.
//
// Run in the REPL:
//   > :load src/account.bt
//   > :load test/account_test.bt
//   > AccountTest runAll

TestCase subclass: AccountTest

  testInitialBalanceIsZero =>
    self assert: (Account spawn balance await) equals: 0

  testDeposit =>
    acct := Account spawn.
    self assert: ((acct deposit: 100) await) equals: 100

  testDepositReturnsNewBalance =>
    acct := Account spawn.
    (acct deposit: 200) await.
    self assert: ((acct deposit: 50) await) equals: 250

  testWithdraw =>
    acct := Account spawn.
    (acct deposit: 500) await.
    self assert: ((acct withdraw: 200) await) equals: 300

  testWithdrawReturnsNewBalance =>
    acct := Account spawn.
    (acct deposit: 1000) await.
    (acct withdraw: 400) await.
    self assert: (acct balance await) equals: 600

  testMultipleDeposits =>
    acct := Account spawn.
    (acct deposit: 100) await.
    (acct deposit: 200) await.
    (acct deposit: 300) await.
    self assert: (acct balance await) equals: 600

  testOverdraftRaisesError =>
    acct := Account spawn.
    (acct deposit: 100) await.
    self should: [(acct withdraw: 9999) await] raise: #user_error

  testWithdrawExactBalance =>
    // Withdrawing exactly the balance is allowed
    acct := Account spawn.
    (acct deposit: 500) await.
    self assert: ((acct withdraw: 500) await) equals: 0

  testNegativeDepositRaisesError =>
    acct := Account spawn.
    self should: [(acct deposit: -50) await] raise: #user_error

  testNegativeWithdrawRaisesError =>
    acct := Account spawn.
    (acct deposit: 100) await.
    self should: [(acct withdraw: -10) await] raise: #user_error

  testSetAndGetOwner =>
    acct := Account spawn.
    (acct setOwner: "Alice") await.
    self assert: (acct getOwner await) equals: "Alice"

  testDefaultOwnerIsEmpty =>
    self assert: (Account spawn getOwner await) equals: ""

  testBalanceUnaffectedByOwnerChange =>
    acct := Account spawn.
    (acct deposit: 300) await.
    (acct setOwner: "Bob") await.
    self assert: (acct balance await) equals: 300

  testIndependentAccounts =>
    // Each spawned actor has isolated state
    a := Account spawn.
    b := Account spawn.
    (a deposit: 1000) await.
    (b deposit: 500) await.
    (a withdraw: 200) await.
    self assert: (a balance await) equals: 800.
    self assert: (b balance await) equals: 500
