// Copyright 2026 James Casey
// SPDX-License-Identifier: Apache-2.0

// BUnit tests for the Account actor.
//
// Run in the REPL:
//   > :load src/account.bt
//   > :load test/account_test.bt
//   > AccountTest runAll

TestCase subclass: AccountTest

  testInitialBalanceIsZero =>
    self assert: (Account spawn balance) equals: 0

  testDeposit =>
    acct := Account spawn.
    self assert: ((acct deposit: 100)) equals: 100

  testDepositReturnsNewBalance =>
    acct := Account spawn.
    acct deposit: 200.
    self assert: ((acct deposit: 50)) equals: 250

  testWithdraw =>
    acct := Account spawn.
    acct deposit: 500.
    self assert: ((acct withdraw: 200)) equals: 300

  testWithdrawReturnsNewBalance =>
    acct := Account spawn.
    acct deposit: 1000.
    acct withdraw: 400.
    self assert: (acct balance) equals: 600

  testMultipleDeposits =>
    acct := Account spawn.
    acct deposit: 100.
    acct deposit: 200.
    acct deposit: 300.
    self assert: (acct balance) equals: 600

  testOverdraftRaisesError =>
    acct := Account spawn.
    acct deposit: 100.
    self should: [acct withdraw: 9999] raise: #user_error

  testWithdrawExactBalance =>
    // Withdrawing exactly the balance is allowed
    acct := Account spawn.
    acct deposit: 500.
    self assert: ((acct withdraw: 500)) equals: 0

  testNegativeDepositRaisesError =>
    acct := Account spawn.
    self should: [acct deposit: -50] raise: #user_error

  testNegativeWithdrawRaisesError =>
    acct := Account spawn.
    acct deposit: 100.
    self should: [acct withdraw: -10] raise: #user_error

  testSetAndGetOwner =>
    acct := Account spawn.
    acct setOwner: "Alice".
    self assert: (acct getOwner) equals: "Alice"

  testDefaultOwnerIsEmpty =>
    self assert: (Account spawn getOwner) equals: ""

  testBalanceUnaffectedByOwnerChange =>
    acct := Account spawn.
    acct deposit: 300.
    acct setOwner: "Bob".
    self assert: (acct balance) equals: 300

  testIndependentAccounts =>
    // Each spawned actor has isolated state
    a := Account spawn.
    b := Account spawn.
    a deposit: 1000.
    b deposit: 500.
    a withdraw: 200.
    self assert: (a balance) equals: 800.
    self assert: (b balance) equals: 500
