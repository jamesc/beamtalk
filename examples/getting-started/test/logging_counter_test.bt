// Copyright 2026 James Casey
// SPDX-License-Identifier: Apache-2.0

// BUnit tests for the LoggingCounter actor
//
// Requires counter.bt loaded first (LoggingCounter extends Counter)
//
// Run in the REPL:
//   > :load src/counter.bt
//   > :load src/logging_counter.bt
//   > :load test/logging_counter_test.bt
//   > LoggingCounterTest runAll

TestCase subclass: LoggingCounterTest

  setUp =>
    self.ts := TranscriptStream spawn
    TranscriptStream current: self.ts
    self

  tearDown =>
    TranscriptStream current ifNotNil: [:t | t stop]
    TranscriptStream resetCurrent
    self

  testInitialValueIsZero =>
    // Inherits Counter's initial state
    self assert: LoggingCounter spawn getValue equals: 0

  testIncrementDelegatesToSuper =>
    // LoggingCounter#increment logs then delegates to super â€” returns new value
    self assert: LoggingCounter spawn increment equals: 1
    self assert: (self.ts recent includes: "increment called")

  testIncrementLogs =>
    // Each increment call produces a log message
    lc := LoggingCounter spawn
    lc increment
    lc increment
    self assert: (self.ts recent includes: "increment called")

  testDecrementIsInherited =>
    // decrement is inherited from Counter unchanged
    self assert: LoggingCounter spawn decrement equals: -1

  testGetValueIsInherited =>
    lc := LoggingCounter spawn
    lc increment
    lc increment
    self assert: lc getValue equals: 2

  testIncrementAndDecrementInteraction =>
    lc := LoggingCounter spawn
    lc increment; increment; increment; decrement
    self assert: lc getValue equals: 2

  testIndependentInstances =>
    // Each spawned actor has independent state
    lc1 := LoggingCounter spawn
    lc2 := LoggingCounter spawn
    lc1 increment
    lc1 increment
    lc2 increment
    self assert: lc1 getValue equals: 2
    self assert: lc2 getValue equals: 1
