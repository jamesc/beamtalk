// Copyright 2026 James Casey
// SPDX-License-Identifier: Apache-2.0

// Stdlib tests for error handling
// Tests that runtime errors produce correct error kinds
// Validates BT-458: ERROR: assertion support in stdlib test framework
//
// These tests were migrated from E2E where they don't need REPL features.
// Stdlib tests match #beamtalk_error{kind} structurally (more precise than
// E2E substring matching).

// ===========================================================================
// ARITHMETIC ERRORS
// ===========================================================================

// Division by zero (Erlang badarith)
1 / 0
// => ERROR: badarith

// Integer division by zero (Erlang badarith)
1 div: 0
// => ERROR: badarith

// Arithmetic type error (string is not a number)
"hello" + 42
// => ERROR: badarith

// ===========================================================================
// DOES NOT UNDERSTAND (unknown methods)
// ===========================================================================

// Unknown method on integer
42 nonExistentMethod
// => ERROR: does_not_understand

// Unknown method on string
"hello" nonExistentMethod
// => ERROR: does_not_understand

// Unknown method on boolean
true nonExistentMethod
// => ERROR: does_not_understand

// Unknown method on nil
nil nonExistentMethod
// => ERROR: does_not_understand

// ===========================================================================
// IMMUTABLE VALUE ERRORS (BT-359)
// ===========================================================================
// Value types (integers, strings) don't have mutable fields

// instVarAt:put: on integer
42 instVarAt: #x put: 99
// => ERROR: immutable_value

// instVarAt: on integer
42 instVarAt: #x
// => ERROR: immutable_value

// instVarAt:put: on string
"hello" instVarAt: #x put: "world"
// => ERROR: immutable_value

// ===========================================================================
// PRIMITIVE TYPE INSTANTIATION ERRORS (BT-422)
// ===========================================================================
// Primitive types are backed by native BEAM values, not maps.
// Calling `new` on them should raise an instantiation_error.

Integer new
// => ERROR: instantiation_error

String new
// => ERROR: instantiation_error

CompiledMethod new
// => ERROR: instantiation_error

Float new
// => ERROR: instantiation_error

Symbol new
// => ERROR: instantiation_error

True new
// => ERROR: instantiation_error

False new
// => ERROR: instantiation_error

UndefinedObject new
// => ERROR: instantiation_error

Block new
// => ERROR: instantiation_error

// new: on non-instantiable primitives still raises instantiation_error
// because the class can't be constructed at all (BT-473: checked first).
// BT-422: gen_server crash fix ensures class process survives the error.

Integer new: 42
// => ERROR: instantiation_error

String new: "hello"
// => ERROR: instantiation_error

// ===========================================================================
// NON-MAP ARGUMENT TO new: (BT-473)
// ===========================================================================
// Passing a non-Dictionary argument to new: should raise type_error,
// not silently fall back to new/0.

Dictionary new: 42
// => ERROR: type_error

Dictionary new: "hello"
// => ERROR: type_error

Dictionary new: true
// => ERROR: type_error

// ===========================================================================
// FILE I/O ERRORS
// ===========================================================================
// NOTE: File I/O error tests temporarily removed — the underlying File
// operations raise function_clause instead of structured beamtalk_errors.
// See pre-existing failures in file_io.bt E2E tests.
// TODO: Re-add when beamtalk_file.erl properly handles these error paths.

// ===========================================================================
// ACTOR INSTANTIATION ERRORS (BT-623)
// ===========================================================================
// Actors must use spawn/spawnWith: — calling new should raise instantiation_error

// @load stdlib/test/fixtures/counter.bt

Counter new
// => ERROR: instantiation_error

// Abstract class instantiation
Number new
// => ERROR: instantiation_error

Collection new
// => ERROR: instantiation_error

// ===========================================================================
// DOES NOT UNDERSTAND — additional types (BT-623)
// ===========================================================================

// Unknown method on float
3.14 nonExistentMethod
// => ERROR: does_not_understand

// Unknown method on list
#(1, 2) nonExistentMethod
// => ERROR: does_not_understand

// Unknown method on dictionary
#{} nonExistentMethod
// => ERROR: does_not_understand
