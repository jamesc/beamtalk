// Copyright 2026 James Casey
// SPDX-License-Identifier: Apache-2.0

// Test basic reflection API (BT-97)


TestCase subclass: ReflectionBasicTest

  testSection1 =>
    c := Counter spawn.
    // Test class reflection
    self assert: (c class) equals: Counter.
    // Test respondsTo: with symbol literal
    self assert: (c respondsTo: #increment).
    // Test respondsTo: with non-existent method
    self deny: (c respondsTo: #nonExistent).
    // Test fieldNames
    self assert: ((c fieldNames) await) equals: #(#value).
    // Test fieldAt: - read field value
    self assert: ((c fieldAt: #value) await) equals: 0.
    // Increment to change state
    self assert: (c increment await) equals: 1.
    // Test fieldAt: after state change
    self assert: ((c fieldAt: #value) await) equals: 1.
    // Test fieldAt:put: - set field value
    self assert: ((c fieldAt: #value put: 42) await) equals: 42.
    // Verify field was set
    self assert: (c getValue await) equals: 42.
    // Test perform: - dynamic dispatch (zero-arity method)
    self assert: ((c perform: #getValue) await) equals: 42.
    // Test perform: with another method
    self assert: ((c perform: #increment) await) equals: 43.
    // Verify increment worked via getValue
    self assert: (c getValue await) equals: 43.
    // BT-359: fieldAt: on value types raises immutable_value error
    self should: [42 fieldAt: #x] raise: #immutable_value.
    // BT-765: fieldAt:put: on immutable literals raises immutable_value error
    self should: [42 fieldAt: #x put: 99] raise: #immutable_value.
    self should: ["hello" fieldAt: #x put: "world"] raise: #immutable_value
