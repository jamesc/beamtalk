// Copyright 2026 James Casey
// SPDX-License-Identifier: Apache-2.0

// BT-98: Tests that actor field mutations inside do: loops and inject:into: blocks
// are correctly threaded through the state monad â€” setValue, sumArray via do:,
// sumWithInject:, and multi-field accumulation (sum, count, product).


TestCase subclass: FieldMutationsDoTest

  testFieldMutationsWithSetAndDo =>
    counter := FieldMutationCounter spawn.
    self assert: (counter getValue) equals: 0.
    self assert: (counter setValue: 5) equals: 5.
    self assert: (counter getValue) equals: 5.
    self assert: (counter setValue: 10) equals: 10.
    self assert: (counter getValue) equals: 10.
    self assert: (counter setValue: 0) equals: 0.
    self assert: (counter sumArray: #(1, 2, 3)) equals: 6.
    self assert: (counter getValue) equals: 6.
    self assert: (counter setValue: 0) equals: 0.
    self assert: (counter sumArray: #(10, 20, 30)) equals: 60.
    self assert: (counter getValue) equals: 60.
    self assert: (counter sumWithInject: #(1, 2, 3)) equals: 6.
    self assert: (counter sumWithInject: #(100, 200, 300)) equals: 600.
    acc := FieldMutationAccumulator spawn.
    self assert: (acc processArray: #(2, 3, 4)) equals: #{#count => 3, #product => 24, #sum => 9}.
    self assert: (acc getSum) equals: 9.
    self assert: (acc getProduct) equals: 24.
    self assert: (acc getCount) equals: 3
