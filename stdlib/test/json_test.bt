// Copyright 2026 James Casey
// SPDX-License-Identifier: Apache-2.0

// Stdlib tests for JSON class (BT-711)

TestCase subclass: JsonTest

  testParsingPrimitiveValues =>
    self assert: (JSON parse: "42") equals: 42.
    // Parse a JSON float
    self assert: (JSON parse: "3.14") equals: 3.14.
    // Parse JSON true
    self assert: (JSON parse: "true").
    // Parse JSON false
    self deny: (JSON parse: "false").
    // Parse JSON null to nil
    self assert: (JSON parse: "null") equals: nil

  testParsingArrays =>
    // Parse a JSON array of integers
    self assert: (JSON parse: "[1, 2, 3]") equals: #(1, 2, 3).
    // Parse a nested array
    self assert: (JSON parse: "[[1, 2], [3, 4]]") equals: #(#(1, 2), #(3, 4)).
    // Parse a mixed array â€” verify size and individual access
    self assert: ((JSON parse: "[1, true, null]") size) equals: 3.
    // Parse an empty array
    self assert: (JSON parse: "[]") equals: #()

  testGeneratingBeamtalkValueToJsonString =>
    // Generate JSON from a List
    self assert: (JSON generate: #(1, 2, 3)) equals: "[1,2,3]".
    // Generate JSON from an Integer
    self assert: (JSON generate: 42) equals: "42".
    // Generate JSON from true
    self assert: (JSON generate: true) equals: "true".
    // Generate JSON from false
    self assert: (JSON generate: false) equals: "false".
    // Generate JSON from nil (becomes null)
    self assert: (JSON generate: nil) equals: "null".
    // Generate JSON from an empty List
    self assert: (JSON generate: #()) equals: "[]"

  testRoundTripGenerateThenParse =>
    // Round-trip an integer
    self assert: (JSON parse: (JSON generate: 42)) equals: 42.
    // Round-trip a boolean
    self assert: (JSON parse: (JSON generate: true)).
    // Round-trip null
    self assert: (JSON parse: (JSON generate: nil)) equals: nil.
    // Round-trip an array
    self assert: (JSON parse: (JSON generate: #(1, 2, 3))) equals: #(1, 2, 3).
    // Round-trip a Dictionary
    self assert: ((JSON parse: (JSON generate: #{"name" => "Ada"})) at: "name") equals: "Ada".
    // Round-trip nested structures
    self assert: (((JSON parse: (JSON generate: #{"user" => #{"age" => 36}})) at: "user") at: "age") equals: 36

  testDictionaryGenerateAndParse =>
    // Generate JSON from a Dictionary, then verify structure
    self assert: ((JSON generate: #{"a" => 1}) size > 2).
    // Generate and re-parse a Dictionary
    self assert: ((JSON parse: (JSON generate: #{"x" => 10, "y" => 20})) at: "x") equals: 10.
    self assert: ((JSON parse: (JSON generate: #{"x" => 10, "y" => 20})) at: "y") equals: 20.
    self assert: ((JSON parse: (JSON generate: #{"x" => 10, "y" => 20})) size) equals: 2.
    // Dictionary with nested List
    self assert: ((JSON parse: (JSON generate: #{"items" => #(1, 2, 3)})) at: "items") equals: #(1, 2, 3).
    // Dictionary with boolean values
    self assert: ((JSON parse: (JSON generate: #{"active" => true})) at: "active").
    // Dictionary with null value
    self assert: ((JSON parse: (JSON generate: #{"value" => nil})) at: "value") equals: nil

  testPrettyPrinting =>
    // Pretty print produces a non-empty string
    self assert: ((JSON prettyPrint: #{"a" => 1}) size > 0).
    // Pretty print produces same data as generate when re-parsed
    self assert: ((JSON parse: (JSON prettyPrint: #{"a" => 1})) at: "a") equals: 1

  testErrorHandling =>
    // Parse invalid JSON produces a parse_error
    self should: [JSON parse: "not json"] raise: #parse_error.
    // Parse with non-string argument produces type_error
    self should: [JSON parse: 42] raise: #type_error

  testClassIdentity =>
    // BT-802 (ADR 0036): class on class returns a real metaclass object
    self assert: (JSON class) isMeta equals: true
