// Copyright 2026 James Casey
// SPDX-License-Identifier: Apache-2.0

// BT-984: BUnit tests for Object>>trace: and Object>>traceCr:
//
// Verifies:
// - Silent no-op when TranscriptStream current is nil
// - Output is routed when a transcript instance is set as current

TestCase subclass: TraceCrTest

  setUp =>
    // Ensure current is nil before each test (default in test environment)
    TranscriptStream resetCurrent
    self

  tearDown =>
    // Stop per-test transcript actor when one was set
    TranscriptStream current ifNotNil: [:t | t stop]
    // Restore nil state after each test
    TranscriptStream resetCurrent
    self

  testTraceCrNilSafeWhenNoTranscript =>
    // When TranscriptStream current is nil, traceCr: is a no-op and returns self
    TranscriptStream resetCurrent
    self assert: (42 traceCr: "hello") equals: 42

  testTraceNilSafeWhenNoTranscript =>
    // When TranscriptStream current is nil, trace: is a no-op and returns self
    TranscriptStream resetCurrent
    self assert: (42 trace: "hello") equals: 42

  testTraceCrRoutesOutputWhenTranscriptSet =>
    // When a TranscriptStream is set as current, traceCr: routes output to it
    ts := TranscriptStream spawn
    TranscriptStream current: ts
    42 traceCr: "hello"
    self assert: (ts recent includes: "hello")

  testTraceRoutesOutputWhenTranscriptSet =>
    // When a TranscriptStream is set as current, trace: routes output to it
    ts := TranscriptStream spawn
    TranscriptStream current: ts
    42 trace: "world"
    self assert: (ts recent includes: "world")
