// Copyright 2026 James Casey
// SPDX-License-Identifier: Apache-2.0

// Stdlib tests for string interpolation (ADR 0023 Phase 3, BT-558)


TestCase subclass: StringInterpolationTest

  testBasicStringTestsNoInterpolationZeroOverhead =>
    self assert: "Hello" equals: "Hello"

  testVariableInterpolation =>
    // Simple variable interpolation
    name := "World"
    self assert: name equals: "World"
    self assert: "Hello, {name}!" equals: "Hello, World!"
    // Variable at start
    self assert: "{name} says hi" equals: "World says hi"
    // Variable at end
    self assert: "Hi {name}" equals: "Hi World"
    // Only variable (no literal segments)
    self assert: "{name}" equals: "World"

  testExpressionInterpolation =>
    // Arithmetic expression
    self assert: "Sum: {2 + 3}" equals: "Sum: 5"

  testPrintstringConversion =>
    // Integer printString
    self assert: "Age: {30}" equals: "Age: 30"
    // Boolean interpolation
    self assert: "Flag: {true}" equals: "Flag: true"
    self assert: "Flag: {false}" equals: "Flag: false"
    // Nil interpolation
    self assert: "Value: {nil}" equals: "Value: nil"
    // Symbol interpolation (displayString: no # prefix)
    self assert: "Symbol: {#hello}" equals: "Symbol: hello"

  testNestedMessageSends =>
    // String message in interpolation
    self assert: "Length: {"hello" length}" equals: "Length: 5"

  testMultipleInterpolations =>
    // Two variables
    first := "Alice"
    self assert: first equals: "Alice"
    last := "Bob"
    self assert: last equals: "Bob"
    self assert: "Name: {first} {last}" equals: "Name: Alice Bob"
    // Mixed literals and expressions
    self assert: "a{1}b{2}c" equals: "a1b2c"
    // Adjacent interpolations
    self assert: "{first}{last}" equals: "AliceBob"

  testEscapedBraces =>
    // Escaped braces produce literal braces (backslash preserved in output)
    self assert: "Literal: \{not interpolated\}" equals: "Literal: \{not interpolated\}"

  testEmptyAndEdgeCases =>
    // Empty string
    self assert: "" equals: ""
    // String with only literals
    self assert: "no interpolation here" equals: "no interpolation here"

  testUnicodeContent =>
    // Unicode in literal segments
    self assert: "Hello ðŸŽ‰" equals: "Hello ðŸŽ‰"
    // Unicode variable
    emoji := "ðŸš€"
    self assert: emoji equals: "ðŸš€"
    self assert: "Launch: {emoji}" equals: "Launch: ðŸš€"
    // CJK characters
    self assert: "æ—¥æœ¬èªž: {42}" equals: "æ—¥æœ¬èªž: 42"

  testActorInterpolationAutoAwait =>
    // Actor printString auto-awaits the future
    c := Counter spawn
    self assert: "Actor: {c}" equals: "Actor: a Counter"
