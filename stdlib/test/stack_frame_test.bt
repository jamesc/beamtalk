// Copyright 2026 James Casey
// SPDX-License-Identifier: Apache-2.0

// StackFrame introspection tests - migrated from bootstrap/stack_frames.bt (BT-827)

TestCase subclass: StackFrameTest

  testStackTraceExists =>
    // stackTrace returns a list
    result := [1 / 0] on: Exception do: [:e | e stackTrace class].
    self assert: result equals: List

  testStackTraceHasEntries =>
    // stackTrace has entries
    result := [1 / 0] on: Exception do: [:e | e stackTrace size > 0].
    self assert: result

  testStackTraceFromDoesNotUnderstand =>
    // stackTrace from does_not_understand has entries
    result := [42 noSuchMethod] on: Exception do: [:e | e stackTrace size > 0].
    self assert: result

  testHandlerWithoutArg =>
    // Handler without arg still works
    result := [1 / 0] on: Exception do: [42].
    self assert: result equals: 42

  testRuntimeErrorStackTrace =>
    // RuntimeError also has stackTrace
    result := [42 noSuchMethod] on: RuntimeError do: [:e | e stackTrace class].
    self assert: result equals: List

  testStackFrameClass =>
    // stackTrace first is a StackFrame
    result := [1 / 0] on: Exception do: [:e | e stackTrace first class].
    self assert: result equals: StackFrame

  testStackFrameMethod =>
    // StackFrame method returns a Symbol
    result := [1 / 0] on: Exception do: [:e | (e stackTrace first method) class].
    self assert: result equals: Symbol

  testStackFrameArguments =>
    // StackFrame arguments returns an Integer (arity)
    result := [1 / 0] on: Exception do: [:e | (e stackTrace first arguments) class].
    self assert: result equals: Integer

  testStackFramePrintString =>
    // StackFrame printString returns a String
    result := [1 / 0] on: Exception do: [:e | (e stackTrace first printString) class].
    self assert: result equals: String

  testStackFrameLineType =>
    // StackFrame line returns Integer or nil
    result := [1 / 0] on: Exception do: [:e | (e stackTrace first line) class].
    // Result can be Integer or nil (no assertion on specific value)
    self assert: true

  testStackFrameFileType =>
    // StackFrame file returns String or nil
    result := [1 / 0] on: Exception do: [:e | (e stackTrace first file) class].
    // Result can be String or nil (no assertion on specific value)
    self assert: true

  testStackFrameModuleNameType =>
    // StackFrame moduleName returns a String or nil
    result := [1 / 0] on: Exception do: [:e | (e stackTrace first moduleName) class].
    // Result can be String or nil (no assertion on specific value)
    self assert: true

  testStackFrameReceiverClass =>
    // StackFrame receiverClass from division by zero
    result := [1 / 0] on: Exception do: [:e | (e stackTrace first receiverClass) class].
    // Result may be a class or nil (no assertion on specific value)
    self assert: true

  testStackFrameSourceLocation =>
    // StackFrame sourceLocation returns a String or nil
    result := [1 / 0] on: Exception do: [:e | (e stackTrace first sourceLocation) class].
    // Result can be String or nil (no assertion on specific value)
    self assert: true
