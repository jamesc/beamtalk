// Copyright 2026 James Casey
// SPDX-License-Identifier: Apache-2.0

// Tests that chained message sends on actors work correctly with sync-by-default
// dispatch. When `actor method1 method2` is written, method1 returns the value
// directly (sync gen_server:call), and method2 is dispatched on that value.


TestCase subclass: ActorMessageChainingTest

  // Chained send: actor method returning a primitive, chained with printString
  testChainedPrimitiveMethodResult =>
    a := ActorChainingFixture spawn.
    // getValue returns 0 directly; printString dispatches on 0
    self assert: (a getValue printString) equals: "0"

  // Chained send: method on actor returning itself
  testChainedSelfReturn =>
    a := ActorChainingFixture spawn.
    // getSelf returns the actor directly; getValue dispatches on the actor
    self assert: (a getSelf getValue) equals: 0

  // String interpolation with actor values
  testStringInterpolationWithActorValues =>
    a := ActorChainingFixture spawn.
    a increment.
    self assert: "val={a getValue}" equals: "val=1"

  // Multiple sequential sends
  testSequentialSends =>
    a := ActorChainingFixture spawn.
    a increment.
    a increment.
    a increment.
    self assert: (a getValue) equals: 3

  // Chained send: method dispatched on actor-method result
  testChainedSendOnActorMethodResult =>
    a := ActorChainingFixture spawnWith: #{value => 42}.
    // getName returns a string directly; size is dispatched on the string
    self assert: (a getName size) equals: 7

  // Chained send: getValue → printString (sync dispatch, no intermediary Future)
  testImplicitChaining =>
    a := ActorChainingFixture spawn.
    self assert: (a getValue printString) equals: "0"

  // Chained send on string result
  testChainedOnStringResult =>
    a := ActorChainingFixture spawn.
    self assert: (a getName size) equals: 7

  // Multi-step chaining (actor → actor → primitive)
  testMultiStepChaining =>
    a := ActorChainingFixture spawn.
    // getSelf returns the actor; getValue returns 0; printString dispatches on 0.
    self assert: (a getSelf getValue printString) equals: "0"
