// Copyright 2026 James Casey
// SPDX-License-Identifier: Apache-2.0

// BT-510, BT-776, ADR 0032 Phase 2: Tests class method reflection — methods
// returns only methods defined directly on the class, allMethods returns the full
// inheritance chain, and respondsTo: works on class objects.


TestCase subclass: ClassReflectionTest

  testLocalAndFullMethodLists =>
    counterLocal := Counter methods.
    self deny: (counterLocal isEmpty).
    // Counter defines increment, decrement, getValue locally
    self assert: (counterLocal includes: #increment).
    self assert: (counterLocal includes: #decrement).
    self assert: (counterLocal includes: #getValue).
    // Inherited methods are NOT in methods
    self deny: (counterLocal includes: #isNil).
    self deny: (counterLocal includes: #respondsTo:).
    // ---------------------------------------------------------------------------
    counterMethods := Counter allMethods.
    // Counter allMethods — full inheritance chain
    self deny: (counterMethods isEmpty).
    // Local methods are present
    self assert: (counterMethods includes: #increment).
    // ---------------------------------------------------------------------------
    self assert: (counterMethods includes: #getValue).
    // Inherited methods ARE in allMethods (full chain)
    self assert: (counterMethods includes: #isNil).
    self assert: (counterMethods includes: #respondsTo:).
    // ---------------------------------------------------------------------------
    intMethods := Integer allMethods.
    // Primitive class — full chain still works
    self deny: (intMethods isEmpty).
    // isNil is inherited from Object/ProtoObject — included in full chain
    self assert: (intMethods includes: #isNil).
    // ---------------------------------------------------------------------------
    // BT-776: respondsTo: on class objects (virtual metaclass tag fix)
    // Class methods defined on Class/Behaviour should be found
    self assert: (Counter respondsTo: #name).
    self assert: (Counter respondsTo: #superclass).
    // Inherited Object methods should be found
    self assert: (Counter respondsTo: #isNil).
    // Non-existent methods should return false
    self deny: (Counter respondsTo: #bogus)

  // BT-942: superclass returns correct value via __beamtalk_meta/0 fast path
  testActorSuperclassReflection =>
    self assert: (Counter superclass) equals: Actor
