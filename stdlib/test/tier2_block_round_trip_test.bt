// Copyright 2026 James Casey
// SPDX-License-Identifier: Apache-2.0

// BT-851/BT-852/BT-853: Tier 2 block round-trip tests (ADR 0041 Phase 1).
// Verifies the stateful block calling convention works end-to-end:
// a block with captured mutations is passed via self-send to a HOM,
// the HOM calls `value:` with the Tier 2 protocol, and the mutation
// propagates back to the caller.

TestCase subclass: Tier2BlockRoundTripTest

  // BT-851: Basic round-trip: block mutates count, HOM is last expression.
  testStatefulBlockViaHOM =>
    actor := Tier2BlockTestActor spawn.
    self assert: (actor testRoundTrip) equals: 5

  // BT-853: Non-last Tier 2 value: call in HOM body.
  // The block mutates count (via StateAcc), the HOM continues and returns 99,
  // but the state update (count=3) must still propagate back to the caller.
  testNonLastTier2ValueCallPropagates =>
    actor := Tier2BlockTestActor spawn.
    self assert: (actor testNonLastTier2ValueCall) equals: 3

  // BT-853: Tier 2 block result captured in local variable in HOM body.
  // Block returns count (=4 after mutation), HOM adds 10, returns 14.
  testTier2ResultCaptureInHOM =>
    actor := Tier2BlockTestActor spawn.
    self assert: (actor testTier2ResultCapture) equals: 14

  // BT-852/BT-853: Two sequential Tier 2 assignment calls in a HOM.
  // Verifies new_state is computed AFTER expression_doc to avoid duplicate
  // Core Erlang state bindings across multiple Tier 2 assignments.
  // Block1: increments count by x, returns count. Block2: multiplies count by x.
  // testTwoBlocks: count starts at 0, after block1(2): count=2, r1=2; after block2(r1=2): count=4, r2=4.
  testTwoSequentialTier2Assignments =>
    actor := Tier2BlockTestActor spawn.
    self assert: (actor testTwoBlocks) equals: 4
