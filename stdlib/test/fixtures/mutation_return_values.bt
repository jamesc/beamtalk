// Copyright 2026 James Casey
// SPDX-License-Identifier: Apache-2.0

// BT-483: Tests that mutation-threaded control flow returns {Result, State}
// When control flow is the last expression in a method, the method should
// return the Result part of the tuple, not nil

Actor subclass: MutationReturnValues
  state: value = 0

  getValue => self.value
  setValue: v => self.value := v

  // inject:into: should return the accumulator result
  // Block receives (accumulator, element) matching Beamtalk convention (BT-820)
  sumViaInject: items =>
    items inject: 0 into: [:acc :elem |
      self.value := self.value + elem
      acc + elem
    ]

  // on:do: should return the try body result on success
  safeAdd: n =>
    [self.value := self.value + n. self.value] on: Exception do: [:e | -1]

  // on:do: should return the handler result on exception
  failingAdd =>
    [self.value := self.value + (1 / 0). self.value] on: Exception do: [:e |
      self.value := self.value + 100
      -999
    ]

  // ensure: should return the try body result
  addWithCleanup: n =>
    [self.value := self.value + n. self.value] ensure: [self.value := self.value + 1000]
