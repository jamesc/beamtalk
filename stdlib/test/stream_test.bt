// Copyright 2026 James Casey
// SPDX-License-Identifier: Apache-2.0

// Stream — constructors, lazy pipeline, terminals

TestCase subclass: StreamTest

  testSection1 =>
    self assert: ((Stream from: 1) take: 5) equals: #(1, 2, 3, 4, 5).
    self assert: ((Stream from: 10) take: 3) equals: #(10, 11, 12).
    self assert: ((Stream from: 0) take: 1) equals: #(0).
    self assert: ((Stream from: -3) take: 4) equals: #(-3, -2, -1, 0).
    // Stream from:by: — step function stream
    self assert: ((Stream from: 1 by: [:n | n * 2]) take: 5) equals: #(1, 2, 4, 8, 16).
    self assert: ((Stream from: 0 by: [:n | n + 10]) take: 4) equals: #(0, 10, 20, 30).
    self assert: ((Stream from: 100 by: [:n | n - 1]) take: 3) equals: #(100, 99, 98).
    // Stream on: — from collection
    self assert: ((Stream on: #(1, 2, 3)) asList) equals: #(1, 2, 3).
    self assert: ((Stream on: #()) asList) equals: #().
    self assert: ((Stream on: #(42)) asList) equals: #(42).
    // select: — filter
    self assert: (((Stream on: #(1, 2, 3, 4, 5)) select: [:n | n > 3]) asList) equals: #(4, 5).
    self assert: (((Stream on: #(1, 2, 3, 4, 5, 6)) select: [:n | n isEven]) asList) equals: #(2, 4, 6).
    // select: on empty
    self assert: (((Stream on: #()) select: [:n | n > 0]) asList) equals: #().
    // collect: — transform
    self assert: (((Stream on: #(1, 2, 3)) collect: [:n | n * 10]) asList) equals: #(10, 20, 30).
    self assert: (((Stream on: #(1, 2, 3)) collect: [:n | n + 100]) asList) equals: #(101, 102, 103).
    // reject: — inverse filter
    self assert: (((Stream on: #(1, 2, 3, 4, 5)) reject: [:n | n > 3]) asList) equals: #(1, 2, 3).
    self assert: (((Stream on: #(1, 2, 3, 4)) reject: [:n | n isEven]) asList) equals: #(1, 3).
    // drop: — skip first N
    self assert: (((Stream on: #(1, 2, 3, 4, 5)) drop: 2) asList) equals: #(3, 4, 5).
    self assert: (((Stream on: #(1, 2, 3)) drop: 0) asList) equals: #(1, 2, 3).
    self assert: (((Stream on: #(1, 2, 3)) drop: 5) asList) equals: #().
    // take: — first N elements
    self assert: ((Stream from: 1) take: 0) equals: #().
    self assert: ((Stream from: 1) take: 3) equals: #(1, 2, 3).
    // take: on finite stream (fewer elements than requested)
    self assert: ((Stream on: #(1, 2)) take: 10) equals: #(1, 2).
    // do: — iterate with side effects
    self assert: ((Stream on: #(1, 2, 3)) do: [:n | n]) equals: nil.
    // inject:into: — fold/reduce
    self assert: ((Stream on: #(1, 2, 3, 4)) inject: 0 into: [:sum :n | sum + n]) equals: 10.
    self assert: ((Stream on: #(1, 2, 3)) inject: 1 into: [:product :n | product * n]) equals: 6.
    self assert: ((Stream on: #()) inject: 42 into: [:acc :n | acc + n]) equals: 42.
    // detect: — first matching element
    self assert: ((Stream on: #(1, 2, 3, 4, 5)) detect: [:n | n > 3]) equals: 4.
    self assert: ((Stream on: #(1, 2, 3)) detect: [:n | n > 10]) equals: nil.
    // asList — materialize
    self assert: ((Stream on: #(10, 20, 30)) asList) equals: #(10, 20, 30).
    // anySatisfy: — any match?
    self assert: ((Stream on: #(1, 2, 3)) anySatisfy: [:n | n > 2]).
    self deny: ((Stream on: #(1, 2, 3)) anySatisfy: [:n | n > 10]).
    self deny: ((Stream on: #()) anySatisfy: [:n | n > 0]).
    // allSatisfy: — all match?
    self assert: ((Stream on: #(1, 2, 3)) allSatisfy: [:n | n > 0]).
    self deny: ((Stream on: #(1, 2, 3)) allSatisfy: [:n | n > 2]).
    self assert: ((Stream on: #()) allSatisfy: [:n | n > 0]).
    // Chained lazy ops on infinite stream
    self assert: (((Stream from: 1) select: [:n | n isEven]) take: 5) equals: #(2, 4, 6, 8, 10).
    self assert: (((Stream from: 1) collect: [:n | n * n]) take: 5) equals: #(1, 4, 9, 16, 25).
    // Multi-step pipeline
    self assert: ((((Stream from: 1) select: [:n | n isEven]) collect: [:n | n * n]) take: 4) equals: #(4, 16, 36, 64).
    // Pipeline with drop
    self assert: (((Stream from: 1) drop: 5) take: 3) equals: #(6, 7, 8).
    // inject on finite stream
    self assert: ((Stream on: #(1, 2, 3, 4, 5)) inject: 0 into: [:sum :n | sum + n]) equals: 15.
    (Stream from: 1) printString.
    (Stream on: #(1, 2, 3)) printString.
    // Pipeline description
    ((Stream from: 1) select: [:n | n isEven]) printString.
    (Stream from: 1) printString.
    self assert: ((Stream from: 1) class) equals: Stream.
    self assert: ((Stream on: #()) take: 5) equals: #().
    self assert: ((Stream on: #()) asList) equals: #().
    self assert: ((Stream on: #()) detect: [:x | x > 0]) equals: nil.
    self deny: ((Stream on: #()) anySatisfy: [:x | x > 0]).
    self assert: ((Stream on: #()) allSatisfy: [:x | x > 0]).
    self assert: ((Stream on: #()) inject: 0 into: [:acc :x | acc + x]) equals: 0.
    self assert: (((Stream on: #(1, 2, 3)) drop: 10) asList) equals: #()

  testInstanceMethodTypeErrors =>
    // Instance method type errors (constructor errors cannot be tested due to gen_server limitation)
    self should: [(Stream from: 1) select: "not a block"] raise: #type_error.
    self should: [(Stream from: 1) collect: 42] raise: #type_error.
    // BT-765: take: with non-integer argument raises type_error
    self should: [(Stream from: 1) take: "five"] raise: #type_error
