%% Umbrella project layout (ADR 0007)
{project_app_dirs, ["apps/*"]}.

{erl_opts, [debug_info]}.

{deps, [
    {jsx, "~> 3.0"},
    %% why: WebSocket transport for REPL protocol (ADR 0020)
    {cowboy, "2.12.0"}
]}.

{profiles, [
    {test, [
        {erl_opts, [debug_info]},
        {eunit_opts, [
            {sys_config, ["apps/beamtalk_runtime/test/sys.config"]}
        ]}
    ]}
]}.

%% Compile test fixtures before running tests (portable — no bash dependency)
{pre_hooks, [
    {eunit, "escript apps/beamtalk_runtime/test_fixtures/compile_fixtures.escript"}
]}.

{eunit_opts, []}.

{cover_enabled, true}.
{cover_opts, [verbose]}.
%% Exclude compiled stdlib from cover — .beam files lack 'file' attribute
%% (compiled from Core Erlang, not .erl source)
{cover_excl_apps, [beamtalk_stdlib]}.

{plugins, [
    covertool,
    erlfmt
]}.

%% erlfmt configuration
%% print_width 100 matches project style (same as Rust line length)
%% files uses ** glob (OTP 26+ filelib:wildcard) for umbrella apps/* layout
{erlfmt, [
    {print_width, 100},
    {files, ["apps/**/*.erl", "apps/**/*.hrl", "apps/**/*.app.src"]}
]}.

%% Dialyzer configuration
%% Focus on real errors, not overly-strict specs
{dialyzer, [
    {warnings, [
        error_handling     % Warn about unhandled errors
        % Disabled for now (too noisy, not bugs):
        % underspecs       % Spec is supertype of inferred type
        % unmatched_returns % Expression value is unused
    ]},
    {plt_extra_apps, [jsx, compiler, cowboy, ranch]},
    {exclude_apps, [beamtalk_stdlib]}
]}.
